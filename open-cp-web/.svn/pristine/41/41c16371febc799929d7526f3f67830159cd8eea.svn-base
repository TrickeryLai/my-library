<!-- 模板引擎动态生成整体数据，主要为国际化语言服务 -->
<script id="globalData_loginlog" type="text/html">
<div id="globalData">
    <!-- 搜索框，数据展示，分页 -->
    <div class="page-wrap">

        <div class="row" id='tablebox'  >
            <div class="col-lg-12">
                <div class="panel panel-lined table-responsive mb30 ng-scope">
                    <!-- 搜索框 -->
                    <div class="panel-body" style="padding-bottom: 0px" id='searchData'>
                       <div class="col-md-4">
                            <div class="form-group">
                                <label class="col-md-4 control-label">{{loginName}} </label>
                                <div class="col-md-8">
                                    <input type="text" class="form-control field" name="loginName" placeholder="{{loginName}} " value=""/>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="form-group">
                                <div class="col-md-12">
                                    <div style="width:185px;">
                                      <span id="searchBtn" class="btn btn-primary pull-left fa fa-search"> {{search}}</span>
                                      <span id="resetBtn" class="btn btn-warning pull-right fa fa-refresh"> {{reset}}</span>
                                  </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    
                    <div style="padding: 0 20px;" class="panel-body">
                      
                      <!-- 批量删除 -->
                        <span class="btn btn-sm btn-danger pull-right fa fa-trash-o hoverBtn" id='batchDel' name='批量删除'
                        btnType='remove'></span>
                        <!-- 导出 -->
                        <span class="btn btn-sm btn-primary pull-right fa fa-download hoverBtn" id='Downexcels' name='导出'
                          btnType='export'></span>
                          <!-- 新增 -->
                        <span class="btn btn-sm btn-success pull-right globalData-add fa fa-plus hoverBtn" name='新增'
                        btnType='add'></span>
                    </div>
                    <div class="panel-body">
                        <table class="table table-bordered table-striped zCheckBox">
                            <thead class="thead">
                            <tr>
                                <th><span class="zCBox zCheckAll"></span></th>
                                <th>{{no}}</th>
                                <th>{{loginName}}</th>
                                <th>{{ipaddr}}</th>
                                <th>{{loginLocation}}</th>
                                <th>{{browser}}</th>
                                <th>{{os}}</th>
                                <th>{{status}}</th>
                                <th style="max-width: 300px;text-align: left;">{{msg}}</th>
                                <th>{{time}}</th>
  
                            </tr>
                            </thead>
                            <tbody id="globalDataTbody">
                            <tr>
                                <td colspan="20" style="text-align: center;">{{loading}}</td>
                            </tr>
                            </tbody>
                        </table>
                    <!-- #end data table -->
                    <!-- 分页 -->
                    <div class="page">
                        <div class="pager_container" id="Pagination">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</script>
<!-- 模板引擎动态生成表格数据 -->
<script id="globalDataList_loginLog" type="text/html">
{{if list && list.length > 0 }}
{{each list as value i}}
<tr _id="{{value.infoId}}">
  <td><span class="zCBox"></span></td>
  <td>{{i+1}}</td>
  <td>{{value.loginName}}</td>
  <td>{{value.ipaddr}}</td>

  <td>{{value.loginLocation}}</td>
  <td>{{value.browser}}</td>

  <td>{{value.os}}</td>
  <td>{{value.status | loginStatusFormat}}</td>
  <td style="max-width: 300px;text-align: left;" >{{value.msg}}</td>
  <td>{{value.loginTime }}</td>

</tr>
{{/each}}
{{else}}
<tr>
  <td colspan="10" style="text-align: center;">{{1 | noData}}</td>
</tr>
{{/if}}
</script>
<script>
//定义全局对象
var globalData={
  name:{
    zh_cn:'登录日志',en_us:'Login log',zh_cht:'登录日志'
  },

  detailStr:function(){
    return this['name'][lang.getLang()] + lang.getData('list');
  },

  editStr:function(){
    return lang.getData('edit') + this['name'][lang.getLang()] ;

  },

  addStr:function(){
    return lang.getData('add') + this['name'][lang.getLang()] ;
  },

  delStr:function(name){
    return lang.getData('delStr');
  },


  init:function(){
    //生成整体数据，主要为国际化语言服务
    $('#main').prepend(template('globalData_loginlog',$.dataLanguage()));
    //页面初始化默认请求表格数据
    this.getData(globalData.data);
    //调用所有事件
    this.event();


  },

  //定义全局请求参数对象
  data:{
    pageNum:1,
    pageSize:10
  },

  

  //请求表格数据的函数，参数data
  getData:function(data){
    $.zAjax({
      url: project.host()+'/v1/loginLogs' ,
      data:data,
      isString:false,
      success: function(data) {
            var list=data;
            var total = list.pageInfo.total;
            /**
            * 调用分页方法
            * @param obj.page    分页元素
            * @param obj.url     接口
            * @param obj.tp      模板元素
            * @param obj.ele     填充数据元素
            * @param obj.data    请求参数
            * @param obj.list    请求返回数据
            */
            $.zPageMethod({
              page:'#Pagination',
              url:project.host()+'/v1/loginLogs' ,
              tp:'globalDataList_loginLog',
              ele:'#globalDataTbody',
              total:total,
              data:globalData.data,
              list:list
            });
       }
    });
  },

  //回显数据,同时可用于区分新增和（详情修改）的区别
  getglobalDataDetail:function(_id,ele,view){
    $(ele).find('.field').val('');
    //如果_id有效，则是详情或者修改
    if(_id){
      $.zAjax({
        url: project.host()+'/v1/loginLogs/'+_id ,
        isString:false,
        success: function(data) {
          $(ele).find('.field').each(function(){
            var key=$(this).attr('name');
            $(this).html(data[key]);
            $(this).removeAttr('disabled');
          });

          view();
        }
      });
    }
    //否则是新增
    else{
      view();
    }

  },

  //详情，新增，修改
  updateView:function(title,slef,DelName){
    //获取当前ID，如果是新增，则没有ID
    var _id=$(slef).closest('tr').attr("_id");

    //如果日志点击的是删除
    if(typeof DelName  == 'string'){
      layer.confirm(globalData.delStr(DelName),function(){
        $.zAjax({
          url: project.host()+'/v1/loginLogs/'+_id,
          type:'DELETE',
          isString:false,
          success: function(data) {
            layer.closeAll();
              layer.msg(lang.getData('delSuccess'),{icon:1});
              globalData.getData(globalData.data);      
          }
        });
      })
      return;
    }
    
    /**
   * 集合新增，修改，详情的方法
   * @param1    需展示的title
   * @param2    当前按钮本身
   * @param3    当前数据id
   * @param4    需要验证以及回显数据的表单
   * @param5    回显数据方法
   * @param7    新增，修改，详情的回调
   */
    $.zUpdateView(title,slef,_id,'#dataView',globalData.getglobalDataDetail,{
      //新增的回调,同时将传回通过校验的对象参数
      add:function(data){
        $.zAjax({
          url: project.host()+'/v1/loginLogs' , 
          isString:true,
          type:'post',
          data:data,
          success: function(data) {
            layer.closeAll();
            layer.msg(lang.getData('addSuccess'),{icon:1});
            globalData.getData(globalData.data);
          }
        });
      },
      //编辑的回调,同时将传回通过校验的对象参数
      edit:function(data){
        $.zAjax({
          url: project.host()+'/v1/loginLogs/'+_id , 
          isString:true,
          data:data,
          type:'PUT',
          success: function(data) {
            layer.closeAll();
            layer.msg(lang.getData('editSuccess'),{icon:1});
            globalData.getData(globalData.data);
          }
        });
      },
      //详情的回调
      detail:function(){
      }
    });
  },

  event:function(){

    //导出excels
    $('#Downexcels').click(function(){
      $.downFile({
        url:'loginLogs'
      });  
    })

    //批量删除
    $('#batchDel').click(function(){
      $.batchDel('loginLogs',{nameIndex:2});
        
    })



    //搜索按钮事件
    $('#searchBtn').click(function(){
      var data=$.zSearchFn(globalData.data,'#searchData .field');
      globalData.getData(data);
    });

    //重置按钮事件
    $('#resetBtn').click(function(){
      var data=$.zResetFn(globalData.data,'#searchData .field');
      globalData.getData(data)
    });

    //新增按钮事件
    $('.globalData-add').click(function(){
      globalData.updateView(globalData.addStr(),this);
    });

    //详情，修改，删除按钮的事件
    $('#globalDataTbody').on('click','.btn',function(){
      if($(this).hasClass('detailBtn')){
        globalData.updateView(globalData.detailStr(),this);
      }
      if($(this).hasClass('editBtn')){
        globalData.updateView(globalData.editStr(),this);
      }
      if($(this).hasClass('delBtn')){
        var name=$(this).closest('tr').find('td:eq(2)').html();
        globalData.updateView(globalData.editStr(),this,name);
      }

    });

  }
}
$(document).ready(function() {
  //初始化
    globalData.init();
});

</script>