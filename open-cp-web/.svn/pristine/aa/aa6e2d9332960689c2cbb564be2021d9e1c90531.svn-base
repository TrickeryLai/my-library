<!-- 左侧机构数 
<style type="text/css">
    .orgbox{
        width: 0px;
        float: left;
        background-color: #fff;

        position: absolute;
        top: 0px;
        bottom: 45px;
        z-index: 2;
        overflow: hidden;

    }
    .orgbox.show{
        width: 200px;
        border: 1px solid #eee;
    }
    .orgbox>p{
        width: 100%;
        line-height: 50px;
        text-align: center;
        font-size: 20px;
    }

    #tablebox{
        float: right;
        -o-transition: all 0.2s ease;
        -ms-transition: all 0.2s ease;
        -moz-transition: all 0.2s ease;
        -webkit-transition: all 0.2s ease;
        position: absolute;
        bottom: 0;
        left:0px;
        right: 15px;
        top:0;
        height: 100%;
        overflow: auto;
    }

    #tablebox.add{
        left:15px;

    }
</style>-->

<!-- 模板引擎动态生成整体数据，主要为国际化语言服务 -->
<script id="globalData_company" type="text/html">
    <div id="globalData">
        


        <!-- 详情框 -->
        <div id="dataView" style="min-height: 450px;">  
			<div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{companyName}}：</label>
                    <div class="col-md-8">
                        <input maxlength="30" type="text" class="form-control field fieldReadOnly" name="companyName" placeholder="{{companyName}} " value=""/>
                    </div>
                </div>
            </div> 
			
 			<div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{businessType}}：</label>
                    <div class="col-md-8">
                        <div name="businessType" class=" field" type='specialInput'></div>
                    </div>
                </div>
            </div>
			<div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{legalPerson}}：</label>
                    <div class="col-md-8">
                        <input maxlength="30" type="text" class="form-control field fieldReadOnly" name="legalPerson" placeholder="{{legalPerson}} " value=""/>
                    </div>
                </div>
            </div> 
			<div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{contactEmail}}：</label>
                    <div class="col-md-8">
                        <input maxlength="30" type="text" class="form-control field fieldReadOnly" name="contactEmail" placeholder="{{contactEmail}} " value=""/>
                    </div>
                </div>
            </div> 
			<div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label">{{contactPhone}}：</label>
                    <div class="col-md-8">
                        <input type="text" onkeyup="value=value.replace(/[^\d]/g,'')"  maxlength="11" class="form-control field" name="contactPhone" placeholder="{{contactPhone}}" value=""/>
                    </div>
                </div>
            </div>
			<div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{registerCapital}}：</label>
                    <div class="col-md-8">
                        <input maxlength="30" type="text" class="form-control field fieldReadOnly" name="registerCapital" placeholder="{{registerCapital}} " value=""/>
                    </div>
                </div>
            </div> 
			<div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{registerDate}}：</label>
                    <div class="col-md-8">
                        <input maxlength="30" type="text" class="form-control field fieldReadOnly" name="registerDate" placeholder="{{registerDate}} " value=""/>
                    </div>
                </div>
            </div>
			<div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{personnelScale}}：</label>
                    <div class="col-md-8">
                        <input maxlength="30" type="text" class="form-control field fieldReadOnly" name="personnelScale" placeholder="{{personnelScale}} " value=""/>
                    </div>
                </div>
            </div>
			<div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{enterpriseTypeCHN}}：</label>
                    <div class="col-md-8">
                        <input maxlength="30" type="text" class="form-control field fieldReadOnly" name="enterpriseTypeCHN" placeholder="{{enterpriseTypeCHN}} " value=""/>
                    </div>
                </div>
            </div>
			<div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{enterpriseTypeBank}}：</label>
                    <div class="col-md-8">
                        <input maxlength="30" type="text" class="form-control field fieldReadOnly" name="enterpriseTypeBank" placeholder="{{enterpriseTypeBank}} " value=""/>
                    </div>
                </div>
            </div>
			<div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{industry}}：</label>
                    <div class="col-md-8">
                        <input maxlength="30" type="text" class="form-control field fieldReadOnly" name="industry" placeholder="{{industry}} " value=""/>
                    </div>
                </div>
            </div>
			<div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{registerProvince}}：</label>
                    <div class="col-md-8">
                        <input maxlength="30" type="text" class="form-control field fieldReadOnly" name="registerProvince" placeholder="{{registerProvince}} " value=""/>
                    </div>
                </div>
            </div>
			<div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{registerCity}}：</label>
                    <div class="col-md-8">
                        <input maxlength="30" type="text" class="form-control field fieldReadOnly" name="registerCity" placeholder="{{registerCity}} " value=""/>
                    </div>
                </div>
            </div>
			<div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{registerRegion}}：</label>
                    <div class="col-md-8">
                        <input maxlength="30" type="text" class="form-control field fieldReadOnly" name="registerRegion" placeholder="{{registerRegion}} " value=""/>
                    </div>
                </div>
            </div>
			<div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{registerAddress}}：</label>
                    <div class="col-md-8">
                        <input maxlength="300" type="text" class="form-control field fieldReadOnly" name="registerAddress" placeholder="{{registerAddress}} " value=""/>
                    </div>
                </div>
            </div>
			<div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{businessScope}}：</label>
                    <div class="col-md-8">
                        <input maxlength="300" type="text" class="form-control field fieldReadOnly" name="businessScope" placeholder="{{businessScope}} " value=""/>
                    </div>
                </div>
            </div>
			<div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{incomeSource}}：</label>
                    <div class="col-md-8">
                        <input maxlength="300" type="text" class="form-control field fieldReadOnly" name="incomeSource" placeholder="{{incomeSource}} " value=""/>
                    </div>
                </div>
            </div>
			<div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{otherMemo}}：</label>
                    <div class="col-md-8">
                        <input maxlength="300" type="text" class="form-control field fieldReadOnly" name="otherMemo" placeholder="{{otherMemo}} " value=""/>
                    </div>
                </div>
            </div>
        </div>
        <!-- 搜索框，数据展示，分页 -->
        <div class="page-wrap">

            <!--<div class="orgbox show box box-main" >
                <div class="box-header">
                    <div class="box-title">
                        <i class="fa icon-grid"></i> {{orgId}}
                    </div>
                    <div class="box-tools pull-right">
                        <a type="button" class="btn btn-box-tool menuItem" href="javascript:;" onclick="location.hash='#/orgs'"
                           title="{{orgId}}">
                            <i class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id='orgTree' class="tree" style="overflow: auto;height: 100%;"></div>
            </div>

            <div class="viewFramework-product-navbar-collapse long">
                <div id="product-navbar-btn" class="product-navbar-collapse-inner">
                    <p class="icon-img spin"></p>
                </div>
            </div>-->


            <div class="row" id='tablebox'  >
                <div class="col-lg-12">
                    <div class="panel panel-lined table-responsive mb30 ng-scope">
                        <!-- 搜索框 -->
                        <div class="panel-body" style="padding-bottom: 0px" id='searchData'>

                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-md-4 control-label">{{companyName}}</label>
                                    <div class="col-md-8">
                                        <input type="text"  class="form-control field" name="companyName" placeholder="{{companyName}}" value=""/>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="col-md-4 control-label">{{businessType}}</label>
                                    <div class="col-md-8">
                                        <select name="bussinessType" class="form-control field">
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="form-group">
                                    <div class="col-md-12">
                                        <div style="width:185px;">
                                            <span id="searchBtn" class="btn btn-primary pull-left fa fa-search">{{search}}</span>
                                            <span id="resetBtn" class="btn btn-warning pull-right fa fa-refresh">{{reset}}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


					<!--
                        <div style="padding: 0 20px;" class="panel-body">

                             	批量删除 
                            <span class="btn btn-sm btn-danger pull-right fa fa-trash-o hoverBtn" id='batchDel' name='批量删除'
                                  btnType='remove'></span>
                            <!-- 导出 -->
                            <span class="btn btn-sm btn-primary pull-right fa fa-download hoverBtn" id='Downexcels' name='导出'
                                  btnType='export'></span>
                            <!-- 新增 -->
                            <span class="btn btn-sm btn-success pull-right globalData-add fa fa-plus hoverBtn" name='新增'
                                  btnType='add'></span>
                        </div>
                        <div class="panel-body">
                            <table class="table table-bordered table-striped zCheckBox">
                                <thead class="thead">
                                <tr>
                             
                                    <th>{{companyName}}</th>
									<th>{{orgCode}}</th>
                                    <th>{{organizationCode}}</th>
                                    <th>{{businessType}}</th>
                                    <th>{{operation}}</th>
                                </tr>
                                </thead>
                                <tbody id="globalDataTbody">
                                <tr>
                                    <td colspan="20" style="text-align: center;">{{loading}}</td>
                                </tr>
                                </tbody>
                            </table>
                            <!-- #end data table -->
                            <!-- 分页 -->
                            <div class="page">
                                <div class="pager_container" id="Pagination">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</script>

<!-- 模板引擎动态生成表格数据 -->
<script id="globalDataList_company" type="text/html">
    {{if list && list.length > 0 }}
    {{each list as value i}}
    <tr _id="{{value.companyId}}">
        <td>{{value.companyName}}</td>
		<td>{{value.orgCode}}</td>
        <td>{{value.organizationCode}}</td>
        <td>{{value.businessType | companyBusinessType}}</td>
        
        <td style="min-width: 50px;">
            
            <span class="btn btn-sm btn-info detailBtn fa fa-tags hoverBtn" name='详情' btnType='list'></span>


        </td>
    </tr>
    {{/each}}
    {{else}}
    <tr>
        <td colspan="17" style="text-align: center;">{{1 | noData}}</td>
    </tr>
    {{/if}}
</script>

<script>


    //定义全局对象
    var globalData={
        name:{
            zh_cn:'用户',en_us:'User',zh_cht:'用戶'
        },

        detailStr:function(){
            // return this['name'][lang.getLang()] +'详情&nbsp;<span class="red">只可查看，不可编辑！<span>';
            return this['name'][lang.getLang()] + lang.getData('list');
        },

        editStr:function(){
            // return this['name'][lang.getLang()]+'修改&nbsp;<span class="red">含*的都是必填项！<span>';
            return lang.getData('edit') + this['name'][lang.getLang()] ;

        },

        addStr:function(){
            // return this['name'][lang.getLang()]+'新增&nbsp;<span class="red">含*的都是必填项！<span>';
            return lang.getData('add') + this['name'][lang.getLang()] ;
        },


        delStr:function(name){
            // return '确认删除该'+ this['name'][lang.getLang()] +':<span class="green">'+name+'</span>?&nbsp;&nbsp;<span class="red">请谨慎操作！</span>';

            return lang.getData('delStr');
        },


        init:function(){
            //生成整体数据，主要为国际化语言服务
            $('#main').prepend(template('globalData_company',$.dataLanguage()));

            //页面初始化默认请求表格数据
            this.getData(globalData.data);
            //调用所有事件
            this.event();

            //this.getOrg(globalData.data);
            //this.getRole(globalData.data);
            //填充共同参数
            $.zCompositeData(common_params['rbac']['bussinessType'],'#searchData [name="bussinessType"]',true);
            // $.zCompositeData(common_params['rbac'].sex,'[name="sex"]',true);
            // $.zCompositeData(common_params['rbac'].userType,'[name="userType"]',true);

            //填充特殊共同参数
            $.zSpecialData(common_params['rbac']['businessType'],'#dataView [name="businessType"]');
            //$.zSpecialData(common_params['rbac']['sex'],'#dataView [name="sex"]');
            //$.zSpecialData(common_params['rbac']['userType'],'#dataView [name="userType"]');


            //填充验证
            //$.zCommonReg(reg.email,'#dataView [name="email"]');
            //$.zCommonReg(reg.phonenumber,'#dataView [name="phonenumber"]');
            //$.zCommonReg(reg.password,'#dataView [name="password"]');

            // $.inputReg('[name="phonenumber"]','keyup','number')

            // 调用日期插件
            //laydate.render({
            //    elem: '#startTime',
             //   lang:$.getLayDateLang(),
            //});


        },

        //定义全局请求参数对象
        data:{
            pageNum:1,
            pageSize:10
        },

        getRole:function(data){
            $.zAjax({
                url: project.host()+'/v1/roles' ,
                data:data,
                isString:false,
                success: function(data) {
                	debugger;
                    var roleList=data.list;
                    var str="<li class='zCheckAll zCBox'><span>"+lang.getData('checkall')+"</span><i></i></li>";
                    $('#zCheck').html('').html(str);
                    for(var i=0;i<roleList.length;i++){
                        $('#zCheck').append("<li class='zCBox'></li>");
                        $('#zCheck>li:last').append("<span>"+roleList[i].roleName+"</span><i></i>").attr('roleId',roleList[i].roleId);
                    }
                    
                    var str='<option value="">'+lang.getData('pleaseChoose')+'</option>';
                    roleList.forEach(function(n,i){
                	      str+='<option value='+n.roleId+'>'+n.roleName+'</option>'
                	});

                	$('#role').html(str);
                }
            });
        },

        getOrg:function(data,isOrg){
            /* $.zAjax({
                url: project.host()+'/v1/orgs/orgTreeData' ,
                // data:data,
                isString:false,
                success: function(data) {

                    var html=new treeMenu(data).init({
                        treeType:'orgTree',
                        pIdKey:'pId',
                        pIdInit:'0',
                    });
                    $('#treeBox').html(html);
                    $("#treeBox>ul").treemenu({delay:400}).openActive();
                    if(isOrg)return;
                    $('#orgTree').html(html);
                    $("#orgTree>ul").treemenu({delay:400}).openActive();

                }
            }); */
        },

        //请求表格数据的函数，参数data
        getData:function(data){
            $.zAjax({
                url: project.host()+'/v1/companys' ,
                data:data,
                isString:false,
                success: function(data) {
                    var list=data;
                    var total = list.pageInfo.total;
                    /**
                     * 调用分页方法
                     * @param obj.page    分页元素
                     * @param obj.url     接口
                     * @param obj.tp      模板元素
                     * @param obj.ele     填充数据元素
                     * @param obj.data    请求参数
                     * @param obj.list    请求返回数据
                     */
                    $.zPageMethod({
                        page:'#Pagination',
                        url:project.host()+'/v1/companys' ,
                        tp:'globalDataList_company',
                        ele:'#globalDataTbody',
                        total:total,
                        data:globalData.data,
                        list:list
                    });
                }
            });
        },

        //回显数据,同时可用于区分新增和（详情修改）的区别
        getglobalDataDetail:function(_id,ele,view,slef){
            //$('#passwordConent').hide();
            $('#zCheck li').removeClass('zCheck');
            $('.zRadioBox').removeClass('active');
            $(ele).find('.field').val('');
            //如果_id有效，则是详情或者修改

            $('#zCheck').off().on('click','li',checkAll).removeClass('active');
            if(_id){
                $.zAjax({
                    url: project.host()+'/v1/companys/'+_id ,
                    isString:false,
                    success: function(data) {
                        $(ele).find('.field').each(function(){
                            var key=$(this).attr('name');
                            $(this).val(data[key]);
                            if(key == 'businessType'){
                                $('[name='+key+'] .zRadioBox[value='+data[key]+']').addClass('active');
                            }
                            if(key == 'businessType'){
                                if(data[key] == '00'){
                                    $('#roleIdsP').hide();
                                }else{
                                    $('#roleIdsP').show();
                                }
                            }
                            
                        });


                        $('[name="orgId"]').attr('disabled','disabled').val(data.orgName);
                        $('[name="orgId"]').next('input[type="hidden"]').val(data.orgId);
                        var list=data.roleIds?data.roleIds.split(','):[];
                        list.forEach(function(n,i){
                            $('#zCheck [roleid='+n+']').click();
                        });
                        if($(slef).hasClass('detailBtn')){
                            $('#zCheck').off('click').addClass('active');
                        }
                        view();
                    }
                });
            }
            //否则是新增
            else{
                $('#roleIdsP').show();
                $('#passwordConent').show();
                $('[name="orgId"]').val('').removeAttr('disabled');
                $('[name="orgId"]').next('input[type="hidden"]').val('');
                view();
            }

        },

        //详情，新增，修改
        updateView:function(title,slef,DelName){
            //获取当前ID，如果是新增，则没有ID
            var _id=$(slef).closest('tr').attr("_id");

            //如果用户点击的是删除
            if(typeof DelName  == 'string'){
                layer.confirm(globalData.delStr(DelName),function(){
                    $.zAjax({
                        url: project.host()+'/v1/users/'+_id,
                        type:'DELETE',
                        isString:false,
                        success: function(data) {
                            layer.closeAll();

                            layer.msg(lang.getData('delSuccess'),{icon:1});
                            globalData.getData(globalData.data);
                        }
                    });
                })
                return;
            }

            /**
             * 集合新增，修改，详情的方法
             * @param1    需展示的title
             * @param2    当前按钮本身
             * @param3    当前数据id
             * @param4    需要验证以及回显数据的表单
             * @param5    回显数据方法
             * @param7    新增，修改，详情的回调
             */
            $.zUpdateView(title,slef,_id,'#dataView',globalData.getglobalDataDetail,{
                //新增的回调,同时将传回通过校验的对象参数
                add:function(data){
                    $.zAjax({
                        url: project.host()+'/v1/companys' ,
                        isString:true,
                        type:'post',
                        data:data,
                        success: function(data) {
                            layer.closeAll();
                            layer.msg(lang.getData('addSuccess'),{icon:1});
                            globalData.getData(globalData.data);
                        }
                    });
                },
                //编辑的回调,同时将传回通过校验的对象参数
                edit:function(data){
                    $.zAjax({
                        url: project.host()+'/v1/companys/'+_id ,
                        isString:true,
                        data:data,
                        type:'PUT',
                        success: function(data) {
                            layer.closeAll();
                            layer.msg(lang.getData('editSuccess'),{icon:1});
                            globalData.getData(globalData.data);
                        }
                    });
                },
                //详情的回调
                detail:function(){
                }
            });
        },

        event:function(){

            //导出excels
            $('#Downexcels').click(function(){
                $.downFile({
                    url:'users'
                });
            })

            //批量删除
            $('#batchDel').click(function(){
                $.batchDel('users',{nameIndex:2});
            })

            //左侧机构树点击筛选
            $('#orgTree').on('click','a.treeA',function(){
                $('#orgTree a.treeA').removeClass('active');
                $(this).addClass('active');
                var _id=$(this).attr('_id');
                var data=$.zSearchFn(globalData.data,'#searchData .field');
                globalData.getData($.extend(data,{orgId:_id}));
            })

            //新增和修改选择机构树
            $('#treeBox').on('click','a.treeA',function(){
                $('#treeBox a.treeA').removeClass('active');
                $(this).addClass('active');
            })

            //机构树弹框，包括回显机构树选中状态
            $('[name="orgId"]').click(function(){
                if($(this).attr('disabled'))return;
                var val=$('[name="orgId"]').next('input[type="hidden"]').val();
                if(val == ''){
                    globalData.getOrg(globalData.data,1);
                }else{
                    $('#treeBox a.treeA').removeClass('active');
                    $('#treeBox a.treeA').each(function(i,n) {
                        var _id=$(this).attr('_id');
                        if( _id == val){
                            var _slef=$(this);
                            _slef.addClass('active');
                            $('#treeBox .tree-opened').removeClass().addClass('tree-opened');
                            $('#treeBox .treemenu').show();
                            var _this=$(this);
                            setTimeout(function(argument) {
                                var top=_this.offset().top - 260;
                                $('#treeBox').animate({'scrollTop':top},400,function(){
                                    layer.tips('选中的机构在这里！',_this,{ tips: [1, common_params['rbac']['color']['error'] ] })
                                });
                            },700);
                            return;
                        }
                    });
                }

                var layerT=$.zOpen({
                    title:lang.getData('changeOrg'),
                    ele:'#treeBox',
                    shade:.1,
                    callback:function(){
                        var _slef=$('#treeBox a.treeA.active');
                        var _id=_slef.attr('_id');
                        var _html=_slef.html();

                        if(_id && _html){
                            $('[name="orgId"]').val(_html);
                            $('[name="orgId"]').next('input[type="hidden"]').val(_id);
                            $('[name="orgId"]').closest('div').find('.errMsgSpan').remove();
                            layer.close(layerT);
                        }else{
                            layer.msg(lang.getData('pleaseChangeOrg'));
                            return false
                        }

                    }
                });
            });


            //搜索按钮事件
            $('#searchBtn').click(function(){
                var data=$.zSearchFn(globalData.data,'#searchData .field');
                globalData.getData(data);
            });

            //重置按钮事件
            $('#resetBtn').click(function(){
                globalData.data.orgId=undefined;
                var data=$.zResetFn(globalData.data,'#searchData .field');
                globalData.getOrg(globalData.data);
                globalData.getData(data)
            });
            
			
			
            //新增按钮事件
            $('.globalData-add').click(function(){
                globalData.updateView(globalData.addStr(),this);
            });

            //详情，修改，删除按钮的事件
            $('#globalDataTbody').on('click','.btn',function(){
                var _id=$(this).closest('tr').attr("_id");
                if($(this).hasClass('detailBtn')){
                    globalData.updateView(globalData.detailStr(),this);
                }
                if($(this).hasClass('editBtn')){
                    globalData.updateView(globalData.editStr(),this);
                }
                if($(this).hasClass('delBtn')){
                    var name=$(this).closest('tr').find('td:eq(3)').html();
                    globalData.updateView(globalData.editStr(),this,name);
                }

                if($(this).hasClass('resetPwdBtn')){
                    // var name=$(this).closest('tr').find('td:eq(2)').html();
                    layer.confirm(lang.getData('resetPwdConfirm'),function(){
                        $.zAjax({
                            url: project.host()+'/v1/users/'+_id,
                            type:'PATCH',
                            isString:true,
                            data:{type:'reset'},
                            success: function(data) {
                                layer.closeAll();
                                layer.alert(lang.getData('newPwdToEmail'),{icon:1});
                                globalData.getData(globalData.data);
                            }
                        });
                    })
                }

            });

            //左侧机构树展开收起
            $('#product-navbar-btn').click(function(){
                $(this).find('p').toggleClass('spin');
                $('.viewFramework-product-navbar-collapse').toggleClass('long');
                $('.orgbox').toggleClass('show');
                $('#tablebox').toggleClass('add');
            });
        }
    }
    $(document).ready(function() {
        //初始化
        globalData.init();
    });

</script>