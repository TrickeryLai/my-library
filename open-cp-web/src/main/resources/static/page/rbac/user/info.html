<!-- 模板引擎动态生成整体数据，主要为国际化语言服务 -->
<script id="globalData_info" type="text/html">
<div id="globalData">

    <div id='avatarBox' style="display: none;"></div>

    <div id='treeBox' class="tree" style="overflow: auto;">
      
    </div>
    
    <div style="background: #fff;width: 100%;">
    <!-- 详情框 -->
      <div id="dataView" style="display: block;overflow: hidden;width: 50%;margin: 0 auto">

          <div class="col-md-12">
              <div class="form-group">
                  <label class="col-md-4 control-label">{{avatar}}： </label>
                  <div class="col-md-8" style="margin-bottom: 20px;">
                    <img src="" class="avatar field" name='avatar' id='avatar' for='for-avatar'>
                    <input type="hidden" name="for-avatar" class="form-control">
                  </div>
                  
              </div>
          </div>

          <div class="col-md-12">
              <div class="form-group">
                  <label class="col-md-4 control-label ">{{loginName}}： </label>
                  <div class="col-md-8" >
                      <input type="text" class="form-control field" name="loginName" placeholder="{{loginName}} " value="" disabled='disabled' />
                  </div>
              </div>
          </div>

          <div class="col-md-12">
              <div class="form-group">
                  <label class="col-md-4 control-label">{{userType}}</label>
                  <div class="col-md-8">
                      <div class="form-control field" name="userType" disabled="disabled"  ></div>
                  </div>
              </div>
          </div>


          <div class="col-md-12">
              <div class="form-group">
                  <label class="col-md-4 control-label">{{userName}}： </label>
                  <div class="col-md-8">
                      <input type="text" class="form-control field" name="userName" placeholder="{{userName}} " value=""/>
                  </div>
              </div>
          </div>

          


          <div class="col-md-12">
              <div class="form-group">
                  <label class="col-md-4 control-label ">{{orgId}}：</label>
                  <div class="col-md-8">

                      <div class="form-control field tree" 
                      id='orgTreeSelect' name="orgId" placeholder="{{orgId}} " for='for-orgId' disabled='disabled' >
                          <span class="choice">===请选择===</span>
                      </div>

                      <input type="hidden" name="for-orgId" class="form-control">


                  </div>
              </div>
          </div>
          <div class="col-md-12">
              <div class="form-group">
                  <label class="col-md-4 control-label required">{{email}}：</label>
                  <div class="col-md-8">
                      <input type="text" class="form-control field" name="email" placeholder="{{email}}" value=""/>
                  </div>
              </div>
          </div>
          <div class="col-md-12">
              <div class="form-group">
                  <label class="col-md-4 control-label">{{phonenumber}}：</label>
                  <div class="col-md-8">
                      <input type="text" class="form-control field" name="phonenumber" placeholder="{{phonenumber}}" value=""/>
                  </div>
              </div>
          </div>
          <div class="col-md-12">
              <div class="form-group">
                  <label class="col-md-4 control-label required">{{sex1}}：</label>
                  <div class="col-md-8">
                      <div name="sex" class=" field" type='specialInput'></div>
                  </div>
              </div>
          </div>

         

          <div class="col-md-12"  style="display: none;">
              <div class="form-group">
                  <label class="col-md-4 control-label">{{status}}：</label>
                  <div class="col-md-8">
                      <select name="status" class="form-control field">
                      </select>
                  </div>
              </div>
          </div>

          <div class="col-md-12" id='roleIdsP'>
              <div class="form-group">
                  <label class="col-md-4 control-label ">{{roleIds}}：</label>
                  <div  class="col-md-8">
                      <ul id='zCheck' class="form-control field zCheckBox" name='roleIds' style="border: none;">
                        
                      </ul>
                  </div>
              </div>
          </div>

          <div class="col-md-12" style="margin:20px 0 30px 0;">
              <div class="form-group">
                  <div class="col-md-12">
                      <div style="width:203px;margin: 0 auto">
                        <span id="confirmBtn" class="btn btn-primary pull-left fa fa-check"> {{confirm}}</span>
                        <span onclick='window.history.go(-1)' class="btn btn-warning pull-right fa fa-reply"> {{returnBtn}}</span>
                    </div>
                  </div>
              </div>
          </div>
      </div>
    </div>
</div>
</script>

<script>
//定义全局对象
var globalData={
  init:function(){
    //生成整体数据，主要为国际化语言服务
    $('#main').prepend(template('globalData_info',$.dataLanguage()));


    $('#zCheck').off().on('click','li',checkAll).removeClass('active');
    this.getOrg(globalData.data);
    this.getRole(globalData.data);
    //调用所有事件
    this.event();
    this.getglobalDataDetail(common_data.user.userId)

    $.zCompositeData(common_params['rbac']['status'],'[name="status"]',true);
    // $.zCompositeData(common_params['rbac']['sex'],'[name="sex"]',true);
    // $.zCompositeData(common_params['rbac']['userType'],'[name="userType"]',true);
    //填充验证
    $.zCommonReg(reg.email,'[name="email"]');
    $.zCommonReg(reg.phonenumber,'[name="phonenumber"]');

    $.zSpecialData(common_params['rbac']['sex'],'#dataView [name="sex"]');

    $.inputReg('[name="phonenumber"]','keyup','number')

    for(var i=1;i<7;i++){
      $('#avatarBox').append('<img src="../assets/images/avatar/avatar_0'+i+'.jpg" />')
    }


  },

  //定义全局请求参数对象
  data:{
    pageNum:1,
    pageSize:10
  },



  getRole:function(data){
    $.zAjax({
        url: project.host()+'/v1/roles' ,
        data:data,
        async:false,
        isString:false,
        success: function(data) {
            var roleList=data.list;
            var str="<li class='zCheckAll zCBox'><span>"+lang.getData('checkall')+"</span><i></i></li>";
            $('#zCheck').html('').html(str);
            for(var i=0;i<roleList.length;i++){
              $('#zCheck').append("<li class='zCBox'></li>");
              $('#zCheck>li:last').append("<span>"+roleList[i].roleName+"</span><i></i>").attr('roleId',roleList[i].roleId);
            }
       }
    });
  },

  getOrg:function(data,isOrg){
    $.zAjax({
      url: project.host()+'/v1/orgs/orgTreeData' ,
      // data:data,
      isString:false,
      async:false,
      success: function(data) {

        var html=new treeMenu(data).init({
            treeType:'orgTree',
            pIdKey:'pId',
            pIdInit:'0',
        });
        $('#treeBox').html(html);
        $("#treeBox>ul").treemenu({delay:400}).openActive();
        if(isOrg)return;
        $('#orgTree').html(html);
        $("#orgTree>ul").treemenu({delay:400}).openActive();
           
       }
    });

    
    
  },



  //回显数据,同时可用于区分新增和（详情修改）的区别
  getglobalDataDetail:function(_id){
    //如果_id有效，则是详情或者修改
    if(_id){
      $.zAjax({
        url: project.host()+'/v1/users/'+_id ,
        isString:false,
        success: function(data) {
          $('#dataView').find('.field').each(function(){
            var key=$(this).attr('name');
            $(this).val(data[key]);
            if(key == 'avatar'){
              if(data.avatar){
                $(this).attr('src',data.avatar).val(data.avatar);
                $(this).next('input').val(data.avatar);
              }else{
                $(this).attr('src','../assets/images/'+(data.sex == '1' ? 'man' : 'woman')+'.jpg');
              }
            }

            if(key == 'sex' ){
                $('[name='+key+'] .zRadioBox[value='+data[key]+']').addClass('active');
            }

            if(key == 'userType'){
              if(data[key] == '00'){
                $('[name='+key+']').html('<p>'+lang.getData('superAdmin')+'<span style="font-size: 12px;color: #f00">&nbsp&nbsp&nbsp('+
                  lang.getData('allRolePermissions')+')</span></p>');
                $('#roleIdsP').hide();
              }else{
                $('[name='+key+']').html(lang.getData('ordinaryUser'));
                $('#roleIdsP').show();
              }
                    
            }
          });
          $('#orgTreeSelect>.choice').html(data.orgName);
          $('#orgTreeSelect').next('input[type="hidden"]').val(data.orgId);
          var list=data.roleIds?data.roleIds.split(','):[];
          list.forEach(function(n,i){
            $('#zCheck [roleid='+n+']').click();
          });

          $('#zCheck').off('click').addClass('active');
        }
      });
    }
    

  },

  event:function(){

    //头像点击
    $('#avatar').click(function(){
      $.zOpen({
        title:lang.getData('changeAvatar'),
        ele:'#avatarBox',
        shade:.1,
        btn:[],
        closeBtn:2
      });
    });

    $('#avatarBox').on('click','img',function(){
      var src=$(this).attr('src');
      $('#avatar').attr('src',src);
      $('#avatar').next('input[type="hidden"]').val(src);
      layer.closeAll();
    });

    //新增和修改选择机构树
    $('#treeBox').on('click','a.treeA',function(){
      $('#treeBox a.treeA').removeClass('active');
      $(this).addClass('active');
    })

    //机构树弹框，包括回显机构树选中状态
    $('#orgTreeSelect>.choice').click(function(){
      if($(this).closest('.field').attr('disabled'))return;
      var val=$('#orgTreeSelect').next('input[type="hidden"]').val();
      if(val == ''){
        globalData.getOrg(globalData.data,1);
      }else{
        $('#treeBox a.treeA').removeClass('active');
        $('#treeBox a.treeA').each(function(i,n) {
          var _id=$(this).attr('_id');
          if( _id == val){
            var _slef=$(this);
            _slef.addClass('active');
            $('#treeBox .tree-opened').removeClass().addClass('tree-opened');
            $('#treeBox .treemenu').show();
            var _this=$(this);
            setTimeout(function(argument) {
              var top=_this.offset().top - 260;
              $('#treeBox').animate({'scrollTop':top},400,function(){
                layer.tips(lang.getData('parMenuIsHere'),_this,{ tips: [1, common_params['rbac'].color.error] })
              });
            },700);
            return;
          }
        });
      }

      var layerT=$.zOpen({
        title:"选择机构",
        ele:'#treeBox',
        shade:.1,
        callback:function(){
          var _slef=$('#treeBox a.treeA.active');
          var _id=_slef.attr('_id');
          var _html=_slef.html();

          if(_id && _html){
            $('#orgTreeSelect>.choice').html(_html);
            $('#orgTreeSelect').next('input[type="hidden"]').val(_id);
            layer.close(layerT);
          }else{
            layer.msg('请选择一个机构！');
            return false
          }

        }
      });
    });

    $('#confirmBtn').click(function(argument) {
        var data=$.zValidate('#dataView');
        if(!data)return;
        $.zAjax({
          url: project.host()+'/v1/users/'+common_data.user.userId , 
          isString:true,
          data:data,
          type:'PUT',
          success: function(ee) {
            for(var key in data){
              common_data.user[key]=data[key];
            }

            sessionStorage.setItem('data',JSON.stringify(common_data));
            layer.closeAll();
            layer.msg(lang.getData('editSuccess'),{icon:1});
            $('.avatar').attr('src',data.avatar)

            // setTimeout(function(){
            //   location.reload();
            // },1000);
            

          }
        });
    });
  }
}
$(document).ready(function() {
  //初始化
    globalData.init();
});

</script>