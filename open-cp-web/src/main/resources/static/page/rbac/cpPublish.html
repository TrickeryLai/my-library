<style>
    .layui-upload-img{width: 270px; height: 148px; margin: 0 10px 10px 0;}
    .img_up{
        position: absolute;
        left: 60px;
        top:30px;
        text-align: center;
    }
    .img_up_parents{
        position: relative;
        display: inline-block;
    }
    .none_block {
        display: none;
    }
    .a_none{
        text-decoration:none;
        out-line: none;
        color: #43609c;
    }
    .img_span {
        display: block;
        width: 266px;
    }
</style>

<!-- 生成邀请码的模板 -->
<script id="add_temp" type="text/html">

    <div  class="layui-container" style="position: static">
        <hr class="layui-bg-gray">
        <div class="layui-row" style="position: relative">
            <button onclick="deleteContext(this)" class="layui-btn layui-btn-sm layui-btn-primary" style="position: absolute;right: 10px;"><i class="layui-icon"></i></button>
        </div>
        <div class="layui-row">
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
                <legend>上传票面</legend>
            </fieldset>
        </div>


        <div class="layui-upload layui-row">
            <div class="img_up_parents layui-col-md3 uploadImg1" >
                <input type="hidden" class="field" value="" name ="frontBillImg">
                <div class="img_up">
                    <i class="layui-icon" style="font-size: 50px;margin-left: 10px"></i>
                    <label style="display: block"><span style="color: red">*</span>上传票据正面图片</label>
                </div>
                <img class="layui-upload-img">

            </div>

            <div class="img_up_parents layui-col-md3  uploadImg2" >
                <input type="hidden"  class="field" name ="backBillImg">
                <div class="img_up" >
                    <i class="layui-icon" style="font-size: 50px;margin-left: 10px"></i>
                    <label style="display: block"><span style="color: red">*</span>上传票据反面图片</label>
                </div>
                <img class="layui-upload-img">
            </div>
        </div>
        <div class="layui-row" style="margin-left: 80px;">

            <div  class="layui-col-md3" >正面<a href="javascript:void(0)" onclick="showImg(0)" class="a_none">示例</a></div>
            <div  class="layui-col-md3" >反面<a href="javascript:void(0)" onclick="showImg(1)" class="a_none">示例</a></div>
        </div>


        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px;">
            <legend>填写信息</legend>
        </fieldset>

        <!-- 详情框 -->
        <div id="" class="table" style="margin-top: 20px;">

            <div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{acceptor}}： </label>
                    <div class="col-md-8">
                        <input type="text" class="form-control field fieldReadOnly" name="acceptor" placeholder="{{acceptor}} " value=""/>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{dueDate}}：</label>
                    <div class="col-md-8">
                        <input autocomplete="off" type="text" style="width: 60%;display: inline-block" class="form-control field dueDate" name="dueDate" placeholder="{{dueDate}} " value=""/>
                        剩余<label class="diffDays" value ="1">?</label>天
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{cpAmount}}：</label>
                    <div class="col-md-8">
                        <input type="text" oninput = "value=value.replace(/[^\d^\.]+/g,'')" onkeyup="value=value.replace(/[^\d^\.]+/g,'')"  maxlength="11" class="form-control field" name="cpAmount" placeholder="{{cpAmount}} " value=""/>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{endorseTimes}}：</label>
                    <div class="col-md-8">
                        <div class="layui-btn-group">
                            <button class="layui-btn layui-btn-primary" onclick="addTime(0,this)">0</button>
                            <button class="layui-btn layui-btn-primary" onclick="addTime(1,this)">1</button>
                            <button class="layui-btn layui-btn-primary" onclick="addTime(2,this)">2</button>
                            <button class="layui-btn layui-btn-primary" onclick="addTime(3,this)">3</button>
                        </div>
                        <input type="text" style="width:40%;display: inline-block;" onkeyup="value=value.replace(/[^0-9]/g,'')" class="form-control field" name="endorseTimes" placeholder="{{endorseTimes}} " value=""/>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{cpNo}}：</label>
                    <div class="col-md-8">
                        <input type="text" class="form-control field" name="cpNo" placeholder="{{cpNo}} " value=""/>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{cpDefect}}：</label>
                    <div class="col-md-8">

                        <input style="display: none" type="text" class="form-control field xm-input xm-select" name="cpDefect" placeholder="{{cpDefect}} " value=""/>
                        <div class="select_body" ></div>
                    </div>
                </div>
            </div>
            <div class="col-md-12" style="height: 80px">
                <div class="form-group">
                    <label class="col-md-2 control-label required" style="line-height: 50px">{{selling_rate}}：</label>
                    <div class="col-md-10" style="text-align:center">
                        <div class="col-md-4">{{annual_interest_rate}}</div>
                        <div class="col-md-4">{{deducted}}</div>
                        <div class="col-md-4">{{turnVolume}}</div>
                        <div class="col-md-4">
                            <input  onkeyup="value=value.replace(/^[A-Za-z]+$/g,'')"  style="display: inline-block;width: 90%" type="text" class="form-control field " name="approvalApr" placeholder="{{annual_interest_rate}} " value=""/>
                            <span style="display: inline-block;width: 5%">%</span>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control field " name="deductAmount" placeholder="{{deducted}} " value=""/>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control field " name="turnVolume" placeholder="{{turnVolume}} " value=""/>
                        </div>

                    </div>
                </div>
            </div>
			
        </div>
    </div>
    <div style="margin-bottom: 50px;"></div>
</script>
<!-- 票据发布 -->
<script id="globalData_receviable" type="text/html">

    <div id="globalData1" class="layui-container" style="position: static">
        <div style="margin-top: 30px;"></div>
        <fieldset id="uploadText1" class="layui-elem-field layui-field-title" >
            <legend>上传票面</legend>
        </fieldset>

        <div class="layui-upload layui-row ">
            <div class="img_up_parents layui-col-md3 uploadImg1" >
                <input type="hidden"  class="field" value="" name ="frontBillImg">
                <div class="img_up">
                    <i class="layui-icon" style="font-size: 50px;margin-left: 10px"></i>
                    <label  style="display: block"><span style="color: red">*</span>上传票据正面图片</label>
                </div>
                <img class="layui-upload-img">

            </div>

            <div class="img_up_parents layui-col-md3  uploadImg2" >
                <input type="hidden"  class="field" name ="backBillImg">
                <div class="img_up" >
                    <i class="layui-icon" style="font-size: 50px;margin-left: 10px"></i>
                    <label  style="display: block"><span style="color: red">*</span>上传票据反面图片</label>
                </div>
                <img class="layui-upload-img">
            </div>



        </div>
        <div class="layui-row" style="margin-left: 80px;">
            <div id="photoOne" class="layui-col-md3" >正面<a href="javascript:void(0)" onclick="showImg(0)" class="a_none">示例</a></div>
            <div id="photoTwo" class="layui-col-md3" >反面<a href="javascript:void(0)" onclick="showImg(1)" class="a_none">示例</a></div>
        </div>
			<div id="rejectResult" style="width:auto;height:100px;color:red;font-size:30px;margin-top:20px"><span id="contentReject"></span></div>


        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px;">
            <legend>填写信息</legend>
        </fieldset>

        <!-- 详情框 -->
        <div id="dataForm" class="table" style="margin-top: 20px;">

            <div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{acceptor}}： </label>
                    <div class="col-md-8">
                        <input type="text" class="form-control field fieldReadOnly" name="acceptor" placeholder="{{acceptor}} " value=""/>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{dueDate}}：</label>
                    <div class="col-md-8">
                        <input autocomplete="off" type="text" style="width: 60%;display: inline-block" class="form-control field dueDate" name="dueDate" placeholder="{{dueDate}} " value=""/>
                        剩余<label class="diffDays" value ="1">?</label>天
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{cpAmount}}：</label>
                    <div class="col-md-8">
                        <input type="text" oninput = "value=value.replace(/[^\d^\.]+/g,'')" onkeyup="value=value.replace(/[^\d^\.]+/g,'')"  maxlength="11" class="form-control field" name="cpAmount" placeholder="{{cpAmount}} " value=""/>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{endorseTimes}}：</label>
                    <div class="col-md-8">
                        <div class="layui-btn-group">
                            <button class="layui-btn layui-btn-primary" onclick="addTime(0,this)">0</button>
                            <button class="layui-btn layui-btn-primary" onclick="addTime(1,this)">1</button>
                            <button class="layui-btn layui-btn-primary" onclick="addTime(2,this)">2</button>
                            <button class="layui-btn layui-btn-primary" onclick="addTime(3,this)">3</button>
                        </div>
                        <input type="text" style="width:40%;display: inline-block;" onkeyup="value=value.replace(/[^0-9]/g,'')"  class="form-control field" name="endorseTimes" placeholder="{{endorseTimes}} " value=""/>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{cpNo}}：</label>
                    <div class="col-md-8">
                        <input type="text" class="form-control field" name="cpNo" placeholder="{{cpNo}} " value=""/>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="form-group">
                    <label class="col-md-4 control-label required">{{cpDefect}}：</label>
                    <div class="col-md-8">
                        <input style="display: none" type="text" class="form-control field xm-input xm-select" name="cpDefect" placeholder="{{cpDefect}} " value=""/>
                        <div class="select_body"></div>
                    </div>
                </div>
            </div>


            <div class="col-md-12" style="height: 80px">
                <div class="form-group">
                    <label class="col-md-2 control-label required" style="line-height: 50px">{{selling_rate}}：</label>
                    <div class="col-md-10" style="text-align:center">
                        <div class="col-md-4">{{annual_interest_rate}}</div>
                        <div class="col-md-4">{{deducted}}</div>
                        <div class="col-md-4">{{turnVolume}}</div>
                        <div class="col-md-4">
                            <input  onkeyup="value=value.replace(/^[A-Za-z]+$/g,'')"  style="display: inline-block;width: 90%" type="text" class="form-control field " name="approvalApr" placeholder="{{annual_interest_rate}} " value=""/>
                            <span style="display: inline-block;width: 5%">%</span>
                        </div>
                        <div class="col-md-4">
                            <input  type="text" class="form-control field " name="deductAmount" placeholder="{{deducted}} " value=""/>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control field " name="turnVolume" placeholder="{{turnVolume}} " value=""/>
                        </div>

                    </div>
                </div>
            </div>
            <input type="hidden" id="buyerId" name="buyerId" value=""/>
        </div>
    </div>
    <div class="layui-row layui-container" style="position: static">
        <button id="bottomAdd" class="layui-btn layui-btn-primary text-uppercase layui-col-md12" style="height: 60px;"  onclick="addContext();">
            <i class="layui-icon">&#xe608;</i> {{bottomAdd}}
        </button>
    </div>
    <div class="layui-row layui-container" style="text-align: center; margin-top: 30px;font-size: 20px;" id="statistics"></div>
    <div class="layui-row layui-container" style="margin-top: 50px;position: static" >
        <button class="  btn btn-lg btn-w120 btn-primary " style="width: 300px;height: 60px;margin-left: 10%;"  id="publish">立即发布</button>
        <button class=" btn btn-lg btn-w120 btn-primary " style="width: 300px;height: 60px;margin-right: 10%;float: right;"  id="toBuyer">指定买家</button>
    </div>
    <div style="margin-bottom: 50px;"></div>

</script>

<script id="globalDataList_select" type="text/html">
    <div class="layui-form layui-form-pane"  id="{{selectMsg}}">
        <div class="layui-form-item">
            <div class="layui-input-block" style="margin-left: 0px">
                <select name="city" xm-select="{{selectMsg}}">
                    <option value="无瑕疵" selected="selected">无瑕疵</option>
                    <option value="不可转让">不可转让</option>
                    <option value="同名">同名</option>
                    <option value="回头">回头</option>
                    <option value="上下不一致">上下不一致</option>
                    <option value="保申">保申</option>
                    <option value="质押">质押</option>
                    <option value="小贷">小贷</option>
                    <option value="金融">金融</option>
                    <option value='其他'>
                        其他
                    </option>
                </select>
            </div>
        </div>
    </div>
</script>
<script id="statistics_info" type="text/html">
    总张数:<span style="color: red">{{num}}张</span>,总金额<span style="color: red">{{money}}元</span>

    {{if buyerId}}
    <span>购买人:{{buyerId}}</span>
    <span class="btn btn-sm btn-danger delBtn fa fa-trash-o" onclick="delBuyId()" name='删除'></span>
    {{/if}}
</script>

<script id="uploadImgInfo" type="text/html">

    <!--锁定uploadImgid-->
    <div  class="layui-col-md3  img_up_parents {{imgGlobalId}} ">
        <div class="{{uploadImgId}}" >
            <input type="hidden"  class="field_img" name ="imageName">
            <div class="img_up" >
                <i class="layui-icon" style="font-size: 50px;margin-left: 10px"></i>
                <label  style="display: block">上传票据反面图片</label>
            </div>
            <img class="layui-upload-img">

        </div>
        <span class="btn btn-sm btn-danger fa fa-trash-o img_span"   onclick="removeImg(this)"></span>

    </div>
</script>


<script id="uploadImgInfo1" type="text/html">

    <!--锁定uploadImgid-->
    <div  class="layui-col-md3  img_up_parents {{imgGlobalId}} ">
        <div class="{{uploadImgId}}" >
            <input type="hidden"  class="field_img" name ="imageName">
            <div class="img_up" >
                <i class="layui-icon" style="font-size: 50px;margin-left: 10px"></i>
                <label  style="display: block">上传票据反面图片</label>
            </div>
            <img class="layui-upload-img">

        </div>

    </div>
</script>

<script  id="statusText" type="text/html">
    {{cpStatus | cpStatusFormatText}}
</script>
<script  id="priceInfoText" type="text/html">
    <div  class="layui-container" style="position: static">
        <div class="layui-row">
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px;">
                <legend>报价信息</legend>
            </fieldset>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label class="col-md-4 control-label required">公司名称：</label>
                <div class="col-md-8">
                    <input type="text" class="form-control field" disabled="disabled" value="{{companyName}}"/>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label class="col-md-4 control-label required">竞价金额：</label>
                <div class="col-md-8">
                    <input type="text" class="form-control field" disabled="disabled"  value="{{turnVolume}}"/>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label class="col-md-4 control-label required">年化利率：</label>
                <div class="col-md-8">
                    <input type="text" class="form-control field" disabled="disabled" value="{{approvalApr}}"/>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label class="col-md-4 control-label required">每十万扣款：</label>
                <div class="col-md-8">
                    <input type="text" class="form-control field" disabled="disabled" value="{{deductAmount}}"/>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label class="col-md-4 control-label required">竞价时间：</label>
                <div class="col-md-8">
                    <input type="text" class="form-control field" disabled="disabled"  value="{{quoteTime}}"/>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label class="col-md-4 control-label required">撮合时间	：</label>
                <div class="col-md-8">
                    <input type="text" class="form-control field" disabled="disabled" value="{{matchTime}}"/>
                </div>
            </div>
        </div>
    </div>
</script>


<script>
    //根据扣款计算额度
    function deductedOfTenThound(id){
        var _ele = id;

         //每十万扣款 approvalApr
        var deductAmount = $("#"+_ele+" input[name='deductAmount']").val();
        //天数
        // var diffDays = sessionStorage.getItem('dueDay');
        var diffDays = parseFloat($("#" + _ele).find(".diffDays")[0].innerHTML);
        if(isNaN(deductAmount)){
            return;
        }
        if(isNaN(diffDays)){
            return;
        }
        //年化利率计算
        var approvalApr=deductAmount/100000/diffDays*360*100;
        $("#"+_ele+" input[name='approvalApr']").val(parseFloat(approvalApr).toFixed(8));

        approvalApr=parseFloat(approvalApr).toFixed(8);
        //票据金额
        // var cpAmount = $("#cpAmount").html();
        var cpAmount = $("#"+_ele+" input[name='cpAmount']").val();
        if( isNaN(cpAmount)){
            return ;
        }
        var turnVolume = cpAmount -approvalApr/100/360*diffDays*cpAmount;
        $("#"+_ele+" input[name='turnVolume']").val(parseFloat(turnVolume).toFixed(8))
    }
    //根据成交金额计算额度
    function tradeVolume(id){
        
        var _ele = id;

        //每十万扣款 approvalApr
        var turnVolume = $("#"+_ele+" input[name='turnVolume']").val();
        //天数
        var diffDays = parseFloat($("#" + _ele).find(".diffDays")[0].innerHTML);
        if(isNaN(turnVolume)){
            return;
        }
        if(isNaN(diffDays)){
            return;
        }
      //票据金额
        var cpAmount = $("#"+_ele+" input[name='cpAmount']").val();
        var approvalApr=(1-turnVolume/cpAmount)*100*360/diffDays;
        $("#"+_ele+" input[name='approvalApr']").val(parseFloat(approvalApr).toFixed(8))
        //利息
        var day_rate = (approvalApr/100)/360;
        var day_money =  day_rate*diffDays;
        var money_10  = day_money*100000;
        $("#"+_ele+" input[name='deductAmount']").val(parseFloat(money_10).toFixed(8))
    }

    var uploadContext =["globalData1"];

    function doEdit(editCp) {
        var type = Router.prototype.getParams()["type"];
        var source = Router.prototype.getParams()["source"];
        Object.getOwnPropertyNames(editCp).forEach(function(key){
            var value = $("#globalData1"+" input[name='"+key+"']").val(editCp[key]);
        })
        $('#contentReject').html("票据审核拒绝 : "+editCp["refusalCause"]+" , 请编辑票据内容!");
        var  _str1 =  project.host() + '/v1/images/' + editCp['frontBillImg'];
        var  _str2 =  project.host() + '/v1/images/' + editCp['backBillImg'];
        var _paramsArr =$.packageUploadStr("globalData1","uploadImg1");
        var _paramsArr2 =$.packageUploadStr("globalData1","uploadImg2");

        $(_paramsArr[1]).attr('src', _str1);
        $(_paramsArr[2]).addClass("none_block");
        $(_paramsArr2[1]).attr('src', _str2);
        $(_paramsArr2[2]).addClass("none_block");


        var imageList = editCp["imageList"];
        for (var i=0;i<imageList.length;i++){
            // console.log(imageList[i]["imageName"]);
            //初始化
            var temp ={};
            var datetime = "uploadImg"+new Date().getTime();
            temp["uploadImgId"] = datetime;
            temp["imgGlobalId"] = datetime+"1";
            if(type=='show'){
                $("#globalData1 .layui-upload").append(template("uploadImgInfo1",temp));
            }else{
                $("#globalData1 .layui-upload").append(template("uploadImgInfo",temp));
            }
            var _paramsArr_temp =$.packageUploadStr("globalData1",datetime);
            var o ={id:"globalData1",temp:"uploadImgInfo",imgId:datetime+"1"}
            if(type!='show'){
                $.uploadBillImg(_paramsArr_temp[0],_paramsArr_temp[1],_paramsArr_temp[2],o);
            }
            var  _str_temp =  project.host() + '/v1/images/' + imageList[i]["imageName"];
            $(_paramsArr_temp[1]).attr('src', _str_temp);
            $(_paramsArr_temp[2]).addClass("none_block");

            var _input = $(_paramsArr_temp[0]).children("input");
            _input.val(imageList[i]["imageName"]);
        }
        layui.use(['jquery', 'formSelects'], function(){
            var  formSelects = layui.formSelects;
            var arr = editCp['cpDefect'].split(",");
            formSelects.render("select1",{
                init:arr
            });
        });

        var diffDays = dateDiff(calNowDate(),editCp['dueDate']);
        $("#globalData1").find(".diffDays")[0].innerHTML =diffDays;
        calStatis();
        $("#bottomAdd").hide();
        /*if(editCp['cpStatus']!='01' && editCp['cpStatus']!='05'){
            doHide(editCp);
        }*/

        if(type=='edit'){
        	$('#rejectResult').css("display","none");
        }
        if(type=='show'){
        	if(editCp['cpStatus']=='05'){
        		$('#rejectResult').css("display","block");
        	}
         /*   var temp ={};
            temp["cpStatus"] =editCp['cpStatus'];
            var sHtml =template('statusText',temp)
            $.addWaterMarker(sHtml);
*/

            if(source=="my"){
                if(editCp['priceInfo']!=null){
                    var temp ={};
                    temp["priceInfo"] =editCp['priceInfo'];
                    var sHtml =template('priceInfoText',editCp['priceInfo']);
                    $("#globalData1").after(sHtml);
                }
            }
            doHide(editCp);
        }
    }

    function removeImg(_ele) {
        $(_ele).parent().remove();
    }

    function doHide(editCp) {
        $("#uploadText1").hide();
        $("#photoOne").hide();
        $("#photoTwo").hide();
        $("#publish").hide();
        $("#toBuyer").hide();
        $(":input").attr("disabled", "disabled");
        $("#globalData1 :input").each(function(){
            Object.getOwnPropertyNames(editCp).forEach(function(key){
                $("#globalData1"+" input[name='"+key+"']").attr("disabled",true);
            })
        });

        layui.use(['jquery', 'formSelects'], function(){
            var  formSelects = layui.formSelects;
            var arr = editCp['cpDefect'].split(",");
            formSelects.render("select1",{
                disabled:'disabled'
            });
        });
    }
    function delBuyId() {
        $("#buyerId").val("");
        calStatis();
    }
    function calStatis() {
        var temp={};
        var num =0;
        var money =0;
        for(var i=0;i<uploadContext.length;i++){
            var mon = $("#"+uploadContext[i]+" input[name='cpAmount']").val();
            if(checkRate(mon)){
                money = money+parseFloat(mon);
            }
        }
        num =uploadContext.length;
        temp["num"] = num;
        temp["money"] = money;
        temp["buyerId"] = $("#buyerId").val();
        var sHtml = template("statistics_info",temp)
        $("#statistics").html(sHtml);
    }
    function checkRate(mon) {
        var re = /^[0-9]+.?[0-9]*$/; //判断字符串是否为数字 //判断正整数 /^[1-9]+[0-9]*]*$/

        if (!re.test(mon)) {
            return false;
        }
        return true;
    }
    function addTime(id,_ele) {
        var _input_e = $(_ele).parent().parent().children("input");
        _input_e.val(id);
    }

    function addContext() {
        /*获取html文本*/
        var sHtml =template('add_temp',$.dataLanguage());
        var conLength = uploadContext.length;
        var subStr = uploadContext[uploadContext.length-1].replace("globalData","");

        var realCount =  parseInt(subStr);
        var uploadCount =realCount+1;
        var _id_global ='globalData'+uploadCount ;
        var _id_select ='select'+uploadCount ;
        var context =  $(sHtml).prop('id',_id_global);

        $("#globalData"+realCount).after(context);

        $("#"+_id_global).animate({left:'250px'},300);
        $("#"+_id_global).animate({right:'0px'},300);
        $("#"+_id_global).animate({left:'0px'},400);

        uploadContext.push('globalData'+uploadCount)


        var _paramsArr =$.packageUploadStr(_id_global,"uploadImg1")
        $.uploadBillImg(_paramsArr[0],_paramsArr[1],_paramsArr[2], _id_global);
        var o ={id:_id_global,temp:"uploadImgInfo",imgId:"uploadImg2"}
        var _paramsArr2 =$.packageUploadStr(_id_global,"uploadImg2")
        $.uploadBillImg(_paramsArr2[0],_paramsArr2[1],_paramsArr2[2],o);

        laydate.render({
            elem:  '#'+_id_global+' .dueDate',
            lang:$.getLayDateLang(),
            min:1,
            max:366,
            showBottom: false,
            done: function(value, date){
                if(value!=""){
                    var diffDays = dateDiff(calNowDate(),value);

                    $("#"+_id_global).find(".diffDays")[0].innerHTML =diffDays;
                    $.calMoney(_id_global);
                }

            }
        });

        $("#"+_id_global+" input[name='approvalApr']").bind('input propertychange',function(){
            $.calMoney(_id_global);
        });
        //根据扣款计算
        $("#"+_id_global+" input[name='deductAmount']").bind('input propertychange',function(){
            // $.calMoney(_id_global);
            deductedOfTenThound(_id_global);
        });
        //根据成交金额计算
        $("#"+_id_global+" input[name='turnVolume']").bind('input propertychange',function(){
            tradeVolume(_id_global);
        });
        $("#"+_id_global+" input[name='cpAmount']").bind('input propertychange',function(){
            $.calMoney(_id_global);
            calStatis();
        });

        var temp ={};
        temp["selectMsg"] = _id_select;
        $("#"+_id_global+" .select_body").html(template("globalDataList_select",temp));

        $.formSelectCP(_id_select);

        calStatis();
    }

    function deleteContext(_ele) {
        var id=$(_ele).parent().parent().attr('id');
        var _index = uploadContext.indexOf(id)
        uploadContext.splice(_index,1)
        console.log(uploadContext)
        $("#"+id).remove();
        calStatis();
    }
    function showImg(id) {
        $.getJSON('./../assets/json/photos.json?v='+new Date, function(json){
            layer.photos({
                photos: json[id]
                ,anim: 5,
                id:123
            });
        });
    }
    function dateDiff(sDate1, sDate2) {  //sDate1和sDate2是yyyy-MM-dd格式

        var aDate, oDate1, oDate2, iDays;
        aDate = sDate1.split("-");
        console.log(""+aDate[1] + '-' + aDate[2] + '-' + aDate[0]);
        oDate1 = new Date(aDate[0] + '-' + aDate[1] + '-' + aDate[2]);  //转换为yyyy-MM-dd格式
        aDate = sDate2.split("-");
        oDate2 = new Date(aDate[0] + '-' + aDate[1] + '-' + aDate[2]);
        console.log(oDate1+"--------->"+oDate2)
        iDays = parseInt(Math.abs(oDate1 - oDate2) / 1000 / 60 / 60 / 24); //把相差的毫秒数转换为天数

        return iDays;  //返回相差天数
    }
    function calNowDate() {
        var myDate = new Date();
        var year=myDate.getFullYear();
        var month=myDate.getMonth()+1;
        var date=myDate.getDate();

        var now=year+'-'+getNow(month)+"-"+getNow(date);
        return now;
    }
    function getNow(s) {
        return s < 10 ? '0' + s: s;
    }

    //定义全局对象
    var globalData={
        name:{
            zh_cn:'发布票据',en_us:'release notes',zh_cht:'票據發佈'
        },
        detailStr:function(){
            // return this['name'][lang.getLang()] +'详情&nbsp;<span class="red">只可查看，不可编辑！<span>';
            return this['name'][lang.getLang()] + lang.getData('list');
        },


        //请求表格数据的函数，参数data
        getData:function(data){


        },


        init:function(){
            var type = Router.prototype.getParams()["type"];

            //生成整体数据，主要为国际化语言服务
            $('#main').prepend(template('globalData_receviable',$.dataLanguage()));


            var _paramsArr =$.packageUploadStr("globalData1","uploadImg1");
            if(type !='show'){
                $.uploadBillImg(_paramsArr[0],_paramsArr[1],_paramsArr[2],"globalData1");
            }
            var _paramsArr2 =$.packageUploadStr("globalData1","uploadImg2")
            var o ={id:"globalData1",temp:"uploadImgInfo",imgId:"uploadImg2"}
            //上传背面后需要自动增长
            if(type !='show'){
                $.uploadBillImg(_paramsArr2[0],_paramsArr2[1],_paramsArr2[2],o);
            }
            //页面初始化默认请求表格数据
            this.getData(globalData.data);
            //调用所有事件
            this.event();
            $('#rejectResult').css("display","none");
            $("#globalData1 input[name='approvalApr']").bind('input propertychange',function(){
                $.calMoney("globalData1");
            });
            //根据扣款计算
            $("#globalData1 input[name='deductAmount']").bind('input propertychange',function(){
                // $.calMoney(_id_global);
                deductedOfTenThound("globalData1");
            });
            //根据成交金额计算
            $("#globalData1 input[name='turnVolume']").bind('input propertychange',function(){
                tradeVolume("globalData1");
            });
            $("#globalData1 input[name='cpAmount']").bind('input propertychange',function(){
                $.calMoney("globalData1");
                calStatis();
            });



            laydate.render({
                elem: '#globalData1 .dueDate',
                lang:$.getLayDateLang(),
                min:1,
                max:366,
                showBottom: false,
                done: function(value, date){
                    if(value!=""){

                        var diffDays = dateDiff(calNowDate(),value);
                        $("#globalData1").find(".diffDays")[0].innerHTML =diffDays;
                        $.calMoney("globalData1");
                    }
                }
            });
            var temp ={};
            temp["selectMsg"] = "select1";
            $("#globalData1 .select_body").html(template("globalDataList_select",temp));
            $.formSelectCP("select1");

            calStatis();



            if(type=='edit'||type =='show'){
                var cpId = Router.prototype.getParams()["cpId"];
                $.zAjax({
                    url: project.host()+'/v1/commercialPaper/paper/'+cpId ,
                    type:'get',
                    success: function(data) {
                        doEdit(data.data);
                    }
                });

            }else{
              /*  layer.open({
                    type: 1,
                    title:"关注公众号,获取最新信息",
                    area: ['500px', '500px'],
                    content: '<div style="text-align: center"><img src="../assets/images/weixin.jpg" width="" /></div>'
                });*/
            }
        },


        event:function(){

            $("#toBuyer").click(function () {
                layer.prompt({title: '指定买家', formType:0}, function(text, index){
                    layer.close(index);

                    $.zAjax({
                        url: project.host()+'/v1/commercialPaper/'+text ,
                        type:'get',
                        success: function(data) {
                            console.log(data);
                            if(data.code==0){
                                layer.msg("指定成功");
                                $("#buyerId").val(text);
                                calStatis();
                            }else {
                                layer.msg(data.errMsg);
                            }
                        }
                    });
                });
            });
            $("#publish").click(function(){
                var _len =uploadContext.length;
                var buer={};
                var temp = [];
                for(var i = 0 ;i<_len;i++){
                    var a =  $.zAllValidate("#"+uploadContext[i],"img");
                    
                    if(!a){
                        return ;
                    }

                    if(!a.frontBillImg){
                        layer.msg('请上传票据正面')
                        return;
                    }

                    if(!a.backBillImg){
                        layer.msg('请上传票据反面')
                        return;
                    }

                    if(parseFloat(a.approvalApr) < 0){
                        layer.msg('年化利率不能小于0')
                        return;
                    }

                    if(parseFloat(a.approvalApr) > 100){
                        layer.msg('年化利率不能大于100%')
                        return;
                    }
                    temp.push(a);
                }
                var buyerId = $("#buyerId").val();
                var type = Router.prototype.getParams()["type"];
                if(type == "edit"){
                    var cpId = Router.prototype.getParams()["cpId"];
                    var paper =  $.zAllValidate("#globalData1","img");
                    paper["cpId"] = cpId;
                    paper["buyerId"] = buyerId;
                    $.zAjax({
                        url: project.host()+'/v1/commercialPaper' ,
                        isString:true,
                        type:'put',
                        data:paper,
                        success: function(data) {
                            layer.closeAll();
                            layer.msg(lang.getData('addSuccess'),{icon:1});
                            var index = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(index);
                            parent.globalData.getData1();
                        }
                    });
                    return ;
                }


                buer["cpCommercialPaperInfos"]= temp;
                buer["channel"] = "01";
                buer["buyerId"] = buyerId;
                $.zAjax({
                    url: project.host()+'/v1/commercialPaper' ,
                    isString:true,
                    type:'post',
                    data:buer,
                    success: function(data) {
                        if(data.code == 0){
                            layer.closeAll();

                            layer.alert('发布成功', {
                               closeBtn: 0
                            }, function(){
                                layer.closeAll();
                                layer.open({
                                    type: 1,
                                    title:"关注公众号,获取最新信息",
                                    area: ['500px', '500px'],
                                    content: '<div style="text-align: center"><img src="../assets/images/weixin.jpg" width="" /></div>',
                                    cancel: function(){
                                        window.location.href ="#/mySales";
                                    }
                                });
                            });
                        }else{
                            layer.msg(data.errMsg);
                        }
                       

                    }
                });
            });
        }
    }
    $(document).ready(function() {
        //初始化

        globalData.init();


    });

</script>