<!-- 模板引擎动态生成整体数据，主要为国际化语言服务 -->
<script id="globalData_jobLogs" type="text/html">
<div id="globalData">
    <!-- 详情框 -->
    <div id="dataView">
        <div class="col-md-6">
            <div class="form-group">
                <label class="col-md-4 control-label required">{{jobName}} </label>
                <div class="col-md-8">
                    <input type="text" class="form-control field" name="jobName" placeholder="任务名称 " value=""/>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-group">
                <label class="col-md-4 control-label required">{{jobGroup}} </label>
                <div class="col-md-8">
                    <input type="text" class="form-control field" name="jobGroup" placeholder="{{jobGroup}} " value=""/>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-group">
                <label class="col-md-4 control-label required">{{nodeIp}} </label>
                <div class="col-md-8">
                    <input type="text" class="form-control field" name="nodeIp" placeholder="{{nodeIp}} " value=""/>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-group">
                <label class="col-md-4 control-label required">{{nodePort}} </label>
                <div class="col-md-8">
                    <input type="text" class="form-control field" name="nodePort" placeholder="{{nodePort}} " value=""/>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-group">
                <label class="col-md-4 control-label required">{{serviceName}} </label>
                <div class="col-md-8">
                    <input type="text" class="form-control field" name="serviceName" placeholder="{{serviceName}} " value=""/>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-group">
                <label class="col-md-4 control-label required">{{apiPath}} </label>
                <div class="col-md-8">
                    <input type="text" class="form-control field" name="apiPath" placeholder="{{apiPath}} " value=""/>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-group">
                <label class="col-md-4 control-label required">{{methodParams}} </label>
                <div class="col-md-8">
                    <input type="text" class="form-control field" name="methodParams" placeholder="{{methodParams}} " value=""/>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="form-group">
                <label class="col-md-4 control-label required">{{jobMessage}} </label>
                <div class="col-md-8">
                    <input type="text" class="form-control field" name="jobMessage" placeholder="{{jobMessage}} " value=""/>
                </div>
            </div>
        </div>


        <div class="col-md-6 common_status">
            <div class="form-group">
                <label class="col-md-4 control-label required">{{status}}</label>
                <div class="col-md-8">
                    <select name="status" class="form-control field">
                    </select>
                </div>
            </div>
        </div>


    </div>
    <!-- 搜索框，数据展示，分页 -->
    <div class="page-wrap">

        <div class="row" id='tablebox'  >
            <div class="col-lg-12">
                <div class="panel panel-lined table-responsive mb30 ng-scope">
                    <!-- 搜索框 -->
                    <div class="panel-body" style="padding-bottom: 0px" id='searchData'>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="col-md-4 control-label">{{jobName}}</label>
                                <div class="col-md-8">
                                    <input type="text" class="form-control field" name="jobName" placeholder="{{jobName}}" value=""/>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="col-md-4 control-label">{{serviceName}}</label>
                                <div class="col-md-8">
                                    <input type="text" class="form-control field" name="serviceName" placeholder="{{serviceName}}" value=""/>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="col-md-4 control-label">{{status}}</label>
                                <div class="col-md-8">
                                    <select name="status" class="form-control field">
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <div class="col-md-12">
                                    <div style="width:185px;">
                                      <span id="searchBtn" class="btn btn-primary pull-left fa fa-search"> {{search}}</span>
                                      <span id="resetBtn" class="btn btn-warning pull-right fa fa-refresh"> {{reset}}</span>
                                  </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    
                    <div style="padding: 0 20px;" class="panel-body">
                        <!-- 新增 -->
                        <!-- <span class="btn btn-sm btn-success pull-right globalData-add fa fa-plus hoverBtn" name='新增'
                        btnType='add'></span> -->

                        <!-- 批量删除 -->
                        <span class="btn btn-sm btn-danger pull-right fa fa-trash-o hoverBtn" id='batchDel' name='批量删除'
                         btnType='remove'></span>

                        <!-- 导出 -->
                        <span class="btn btn-sm btn-primary pull-right fa fa-download hoverBtn" id='Downexcels' name='导出'
                          btnType='export'></span>
                    </div>
                    <div class="panel-body">
                        <table class="table table-bordered table-striped zCheckBox">
                            <thead class="thead">
                            <tr>
                                <th><span class="zCBox zCheckAll"></span></th>
                                <th>{{jobNo}}</th>
                                <th>{{jobName}}</th>
                                <th>{{jobGroup}}</th>
                                <th>{{nodeIp}}</th>
                                <th>{{nodePort}}</th>
                                <th>{{serviceName}}</th>
                                <th>{{apiPath}}</th>
                                <th>{{methodParams}}</th>
                                <th>{{jobMessage}}</th>
                                <th>{{status}}</th>
                                <th>{{createTime}}</th>
                                <th>{{operation}}</th>
                            </tr>
                            </thead>
                            <tbody id="globalDataTbody">
                            <tr>
                                <td colspan="20" style="text-align: center;">{{loading}}</td>
                            </tr>
                            </tbody>
                        </table>
                    <!-- #end data table -->
                    <!-- 分页 -->
                    <div class="page">
                        <div class="pager_container" id="Pagination">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</script>
<!-- 模板引擎动态生成表格数据 -->
<script id="globalDataList_jobLogs" type="text/html">
{{if list && list.length > 0 }}
{{each list as value i}}
<tr _id="{{value.jobLogId}}">
  <td><span class="zCBox"></span></td>
  <td style="max-width: 150px;" title="{{value.jobLogId}}">{{value.jobLogId}}</td>
  <td>{{value.jobName}}</td>
  <td>{{value.jobGroup}}</td>
  <td>{{value.nodeIp}}</td>
  <td>{{value.nodePort}}</td>
  <td>{{value.serviceName}}</td>
  <td>{{value.apiPath}}</td>
  <td>{{value.methodParams}}</td>
  <td>{{value.jobMessage}}</td>
  <td>{{value.status | jobLogsStatusFormat }}</td>
  <td>{{value.createTime}}</td>
  <td style="min-width: 100px;">
    <span class="btn btn-sm btn-info detailBtn fa fa-tags hoverBtn"  name='详情'  btnType='list'></span>
    <span class="btn btn-sm btn-danger delBtn fa fa-trash-o hoverBtn" name='删除'  btnType='remove'></span>
  </td>
</tr>
{{/each}}
{{else}}
<tr>
  <td colspan="17" style="text-align: center;">{{1 | noData}}</td>
</tr>
{{/if}}
</script>
<script>
//定义全局对象
var globalData={
  name:{
    zh_cn:'任务日志',en_us:'Tasks log',zh_cht:'任务日志'
  },

  detailStr:function(){
    return this['name'][lang.getLang()] + lang.getData('list');
  },

  editStr:function(){
    return lang.getData('edit') + this['name'][lang.getLang()] ;

  },

  addStr:function(){
    return lang.getData('add') + this['name'][lang.getLang()] ;
  },

  delStr:function(name){
    return lang.getData('delStr');
  },


  init:function(){
    //生成整体数据，主要为国际化语言服务
    $('#main').prepend(template('globalData_jobLogs',$.dataLanguage()));
    //页面初始化默认请求表格数据
    this.getData(globalData.data);
    //调用所有事件
    this.event();

    // this.getMenuTree();
    $.zCompositeData(common_params['rbac']['jobLogsStatus'],'[name="status"]',true);
    // $.zCompositeData(common_params['rbac']jobLogsMisfirePolicy,'[name="misfirePolicy"]',true);

  },

  //定义全局请求参数对象
  data:{
    pageNum:1,
    pageSize:10
  },

  
  //请求表格数据的函数，参数data
  getData:function(data){
    $.zAjax({
      url: project.host()+'/v1/jobLogs' ,
      data:data,
      isString:false,
      success: function(data) {
            var list=data;
            var total = list.pageInfo.total;
            /**
            * 调用分页方法
            * @param obj.page    分页元素
            * @param obj.url     接口
            * @param obj.tp      模板元素
            * @param obj.ele     填充数据元素
            * @param obj.data    请求参数
            * @param obj.list    请求返回数据
            */
            $.zPageMethod({
              page:'#Pagination',
              url:project.host()+'/v1/jobLogs' ,
              tp:'globalDataList_jobLogs',
              ele:'#globalDataTbody',
              total:total,
              data:globalData.data,
              list:list
            });
       }
    });
  },

  //回显数据,同时可用于区分新增和（详情修改）的区别
  getglobalDataDetail:function(_id,ele,view){
    $('#menuTree [_id]').removeClass('active');
    $('.tree-opened').removeClass().addClass('tree-closed');
    $('#menuTree .treemenu').hide();
    $('#menuTree>.treemenu').show();
    $(ele).find('.field').val('');
    //如果_id有效，则是详情或者修改
    if(_id){
      $.zAjax({
        url: project.host()+'/v1/jobLogs/'+_id ,
        isString:false,
        success: function(data) {
          $(ele).find('.field').each(function(){
            var key=$(this).attr('name');
            $(this).val(data[key]);
          });

          view();
        }
      });
    }
    //否则是新增
    else{
      view();
    }

  },

  //详情，新增，修改
  updateView:function(title,slef,DelName){
    //获取当前ID，如果是新增，则没有ID
    var _id=$(slef).closest('tr').attr("_id");

    //如果任务日志点击的是删除
    if(typeof DelName  == 'string'){
      layer.confirm(globalData.delStr(DelName),function(){
        $.zAjax({
          url: project.host()+'/v1/jobLogs/'+_id,
          type:'DELETE',
          isString:false,
          success: function(data) {
            layer.closeAll();
              layer.msg(lang.getData('delSuccess'),{icon:1});
              globalData.getData(globalData.data);      
          }
        });
      })
      return;
    }
    
    /**
   * 集合新增，修改，详情的方法
   * @param1    需展示的title
   * @param2    当前按钮本身
   * @param3    当前数据id
   * @param4    需要验证以及回显数据的表单
   * @param5    回显数据方法
   * @param7    新增，修改，详情的回调
   */
    $.zUpdateView(title,slef,_id,'#dataView',globalData.getglobalDataDetail,{
      //新增的回调,同时将传回通过校验的对象参数
      add:function(data){
        $.zAjax({
          url: project.host()+'/v1/jobLogs' , 
          isString:true,
          type:'post',
          data:data,
          success: function(data) {
            layer.closeAll();
            layer.msg(lang.getData('addSuccess'),{icon:1});
            globalData.getData(globalData.data);
          }
        });
      },
      //编辑的回调,同时将传回通过校验的对象参数
      edit:function(data){
        $.zAjax({
          url: project.host()+'/v1/jobLogs/'+_id , 
          isString:true,
          data:data,
          type:'PUT',
          success: function(data) {
            layer.closeAll();
            layer.msg(lang.getData('editSuccess'),{icon:1});
            globalData.getData(globalData.data);
          }
        });
      },
      //详情的回调
      detail:function(){
      }
    });
  },

  event:function(){

    //导出excels
    $('#Downexcels').click(function(){
      $.downFile({
        url:'jobLogs'
      });  
    })

    //批量删除
    $('#batchDel').click(function(){
      $.batchDel('jobLogs',{nameIndex:2});
        
    });




    //搜索按钮事件
    $('#searchBtn').click(function(){
      var data=$.zSearchFn(globalData.data,'#searchData .field');
      globalData.getData(data);
    });

    //重置按钮事件
    $('#resetBtn').click(function(){
      var data=$.zResetFn(globalData.data,'#searchData .field');
      globalData.getData(data)
    });

    //新增按钮事件
    $('.globalData-add').click(function(){
      globalData.updateView(globalData.addStr(),this);
    });

    //详情，修改，删除按钮的事件
    $('#globalDataTbody').on('click','.btn',function(){
      var _id=$(this).closest('tr').attr("_id");

      if($(this).hasClass('detailBtn')){
        globalData.updateView(globalData.detailStr(),this);
      }

      if($(this).hasClass('editBtn')){
        globalData.updateView(globalData.editStr(),this);
      }

      if($(this).hasClass('delBtn')){
        var name=$(this).closest('tr').find('td:eq(2)').html();
        globalData.updateView(globalData.editStr(),this,name);
      }

      if($(this).hasClass('pauseBtn')){
        layer.confirm('确认要暂停任务日志吗？',function(){
          $.zAjax({
            url: project.host()+'/v1/jobLogs/'+_id,
            type:'PATCH',
            isString:false,
            data:{status:'1'},
            success: function(data) {
              layer.closeAll();
              layer.msg('暂停成功！',{icon:1});
              globalData.getData(globalData.data);      
            }
          });
        })
      }

      if($(this).hasClass('playBtn')){
        layer.confirm('确认要启动任务日志吗？',function(){
          $.zAjax({
            url: project.host()+'/v1/jobLogs/'+_id,
            type:'PATCH',
            isString:false,
            data:{status:'0'},
            success: function(data) {
              layer.closeAll();
              layer.msg('启动成功！',{icon:1});
              globalData.getData(globalData.data);      
            }
          });
        })
      }

      if($(this).hasClass('actionBtn')){
        layer.confirm('确认要执行任务日志吗？',function(){
          $.zAjax({
            url: project.host()+'/v1/jobLogs/run/'+_id,
            type:'PATCH',
            isString:false,
            data:{status:'0'},
            success: function(data) {
              layer.closeAll();
              layer.msg('执行成功！',{icon:1});
              globalData.getData(globalData.data);      
            }
          });
        })
      }

      

    });

  }
}
$(document).ready(function() {
  //初始化
    globalData.init();
});

</script>