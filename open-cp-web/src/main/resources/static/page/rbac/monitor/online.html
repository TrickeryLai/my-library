<!-- 模板引擎动态生成整体数据，主要为国际化语言服务 -->
<script id="globalData_online" type="text/html">
<div id="globalData">
    <!-- 详情框 -->
    <div id="dataView">
    </div>
    <!-- 搜索框，数据展示，分页 -->
    <div class="page-wrap">
        <div class="row" id='tablebox'  >
            <div class="col-lg-12">
                <div class="panel panel-lined table-responsive mb30 ng-scope">
                    <!-- 搜索框 -->
                    <div class="panel-body" style="padding-bottom: 0px" id='searchData'>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="col-md-4 control-label">{{ipaddr}}：</label>
                                <div class="col-md-8">
                                    <input type="text" class="form-control field" name="ipaddr" placeholder="{{ipaddr}}" value=""/>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="col-md-4 control-label">{{loginName}}：</label>
                                <div class="col-md-8">
                                    <input type="text" class="form-control field" name="loginName" placeholder="{{loginName}}" value=""/>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <div class="col-md-12">
                                    <div style="width:185px;">
                                      <span id="searchBtn" class="btn btn-primary pull-left fa fa-search"> {{search}}</span>
                                      <span id="resetBtn" class="btn btn-warning pull-right fa fa-refresh"> {{reset}}</span>
                                  </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    
                    <div style="padding: 0 20px;" class="panel-body">


                        <!-- 批量删除 -->
                        <span class="btn btn-sm btn-danger pull-right fa fa-sign-out hoverBtn" id='batchDel' name='批量强退'
                        btnType='batchForceLogout'></span>

                        <!-- 导出 -->
                        <span class="btn btn-sm btn-primary pull-right fa fa-download hoverBtn" id='Downexcels' name='导出'
                          btnType='export'></span>
                    </div>
                    <div class="panel-body">
                        <table class="table table-bordered table-striped zCheckBox">
                            <thead class="thead">
                            <tr>
                                <th><span class="zCBox zCheckAll"></span></th>
                                <th>{{loginName}}</th>
                                <th>{{orgName}}</th>
                                <th>{{ipaddr}}</th>
                                <th>{{loginLocation}}</th>
                                <th>{{browser}}</th>
                                <th>{{os}}</th>
                                <th>{{status}}</th>
                                <th>{{startTimestamp}}</th>
                                <th>{{lastAccessTime}}</th>
                                <th>{{operation}}</th>
                            </tr>
                            </thead>
                            <tbody id="globalDataTbody">
                            <tr>
                                <td colspan="20" style="text-align: center;">{{loading}}</td>
                            </tr>
                            </tbody>
                        </table>
                    <!-- #end data table -->
                    <!-- 分页 -->
                    <div class="page">
                        <div class="pager_container" id="Pagination">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</script>
<!-- 模板引擎动态生成表格数据 -->
<script id="globalDataList_online" type="text/html">
{{if list && list.length > 0 }}
{{each list as value i}}
<tr _id="{{value.userId}}">
  <td><span class="zCBox" ></span></td>
  <td>{{value.loginName}}</td>
  <td>{{value.orgName}}</td>
  <td>{{value.ipaddr}}</td>
  <td>{{value.loginLocation}}</td>
  <td>{{value.browser}}</td>
  <td>{{value.os}}</td>
  <td>{{value.status | onlineStatusFormat}}</td>
  <td>{{value.startTimestamp}}</td>
  <td>{{value.lastAccessTime}}</td>

  <td style="min-width: 100px;">
    <span class="btn btn-sm btn-danger delBtn fa fa-sign-out hoverBtn" name='强退' btnType='forceLogout'></span>
  </td>
</tr>
{{/each}}
{{else}}
<tr>
  <td colspan="17" style="text-align: center;">{{1 | noData}}</td>
</tr>
{{/if}}
</script>
<script>
//定义全局对象
var globalData={
  name:{
    zh_cn:'在线用户',en_us:'OnlineUser',zh_cht:'在线用户'
  },

  detailStr:function(){
    return this['name'][lang.getLang()] + lang.getData('list');
  },

  editStr:function(){
    return lang.getData('edit') + this['name'][lang.getLang()] ;

  },

  addStr:function(){
    return lang.getData('add') + this['name'][lang.getLang()] ;
  },

  delStr:function(name){
    return lang.getData('delStr');
  },


  init:function(){
    //生成整体数据，主要为国际化语言服务
    $('#main').prepend(template('globalData_online',$.dataLanguage()));
    //页面初始化默认请求表格数据
    this.getData(globalData.data);
    //调用所有事件
    this.event();



  },

  //定义全局请求参数对象
  data:{
    pageNum:1,
    pageSize:10
  },


  

  //请求表格数据的函数，参数data
  getData:function(data){
    $.zAjax({
      url: project.host()+'/v1/userOnlines' ,
      data:data,
      isString:false,
      success: function(data) {
            var list=data;
            var total = list.pageInfo.total;
            /**
            * 调用分页方法
            * @param obj.page    分页元素
            * @param obj.url     接口
            * @param obj.tp      模板元素
            * @param obj.ele     填充数据元素
            * @param obj.data    请求参数
            * @param obj.list    请求返回数据
            */
            $.zPageMethod({
              page:'#Pagination',
              url:project.host()+'/v1/userOnlines' ,
              tp:'globalDataList_online',
              ele:'#globalDataTbody',
              total:total,
              data:globalData.data,
              list:list
            });
       }
    });
  },

 

  event:function(){

    //导出excels
    $('#Downexcels').click(function(){
      $.downFile({
        url:'userOnlines'
      });  
    })



    //批量强退的事件
    $('#batchDel').click(function(){
        var obj=$.zBatchOperation('#tablebox','id',1);
        if(obj.str == ''){
            layer.alert(lang.getData('onlyOneData'),{icon:2});
            return;
        }
        layer.confirm(
          lang.getData('sureForceLogout')+'<br/>'+obj.str1,function(){
            $.zAjax({
              url: project.host()+'/v1/userOnlines/batchForceLogout/'+obj.str,
              type:'DELETE',
              isString:false,
              success: function(data) {
                layer.closeAll();
                  layer.msg(lang.getData('forceLogoutSuccess'),{icon:1});
                  globalData.getData(globalData.data);      
              }
            });
        })
        
    });

    //搜索按钮事件
    $('#searchBtn').click(function(){
      var data=$.zSearchFn(globalData.data,'#searchData .field');
      globalData.getData(data);
    });

    //重置按钮事件
    $('#resetBtn').click(function(){
      var data=$.zResetFn(globalData.data,'#searchData .field');
      globalData.getData(data)
    });


    //强退的事件
    $('#globalDataTbody').on('click','.btn',function(){

      if($(this).hasClass('delBtn')){
        var name=$(this).closest('tr').find('td:eq(2)').html();
        var _id=$(this).closest('tr').attr("_id");
        layer.confirm(lang.getData('sureForceLogout'),function(){
          $.zAjax({
            url: project.host()+'/v1/userOnlines/forceLogout/'+_id,
            type:'DELETE',
            isString:false,
            success: function(data) {
              layer.closeAll();

                layer.msg(lang.getData('forceLogoutSuccess'),{icon:1});
                globalData.getData(globalData.data);      
            }
          });
        })
      }

    });

  }
}
$(document).ready(function() {
  //初始化
    globalData.init();
});

</script>