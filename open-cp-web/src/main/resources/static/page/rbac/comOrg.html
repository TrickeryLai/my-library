<!-- 模板引擎动态生成整体数据，主要为国际化语言服务 -->
<script id="globalData_comOrg" type="text/html">
<div id="globalData">

    <div id='treeBox' class="tree"  style="overflow: auto;">
      
    </div>

    <!-- 详情框 -->
    <div id="dataView" style="width: 850px;height: 700px;">
        <!--<div class="col-md-12 fieldParent">
            <div class="form-group">
                <label class="col-md-4 control-label required">{{parentId}}： </label>
                <div class="col-md-8">
                    <input type="text" class="form-control field" name="parentId" placeholder="{{parentId}} " for='for-parentId' value=""/>
                    <input type="hidden" name="for-parentId" class="form-control">

                </div>
            </div>
        </div>-->

        <div class="col-md-6 fieldParent">
            <div class="form-group">
                <label class="col-md-4 control-label required">{{orgName}}： </label>
                <div class="col-md-8">
                    <input type="text" class="form-control field" name="orgName" placeholder="{{orgName}} " value=""/>
                </div>
            </div>
        </div>

        <div class="col-md-6 fieldParent common_status"  >
            <div class="form-group">
                <label class="col-md-4 control-label required">{{status}}：</label>
                <div class="col-md-8">
                    <!-- <select name="status" class="form-control field">
                    </select> -->

                    <input class="zSwitch form-control field zOrg"  name="status" type="checkbox"  />

                </div>
            </div>
        </div>

        <div class="col-md-6 fieldParent">
            <div class="form-group">
                <label class="col-md-4 control-label required">{{orgOrderNum}}： </label>
                <div class="col-md-8">
                    <input type="text" class="form-control field" name="orderNum" placeholder="{{orgOrderNum}} " value=""/>
                </div>
            </div>
        </div>

        <div class="col-md-6 fieldParent">
            <div class="form-group">
                <label class="col-md-4 control-label required">{{leader}}： </label>
                <div class="col-md-8">
                    <input type="text" class="form-control field" name="leader" placeholder="{{leader}} " value=""/>
                </div>
            </div>
        </div>

        <div class="col-md-6 fieldParent">
            <div class="form-group">
                <label class="col-md-4 control-label">{{phone}}：</label>
                <div class="col-md-8">
                    <input maxlength="11" type="text" class="form-control field" name="phone" placeholder="{{phone}} " value=""/>
                </div>
            </div>
        </div>

        <div class="col-md-6 fieldParent">
            <div class="form-group">
                <label class="col-md-4 control-label">{{email}}： </label>
                <div class="col-md-8">
                    <input type="text" class="form-control field" name="email" placeholder="{{email}} "  value=""/>
                </div>
            </div>
        </div>

		<div class="col-md-6 fieldParent">
            <div class="form-group">
                <label class="col-md-4 control-label required">{{orgCode}}： </label>
                <div class="col-md-8">
                    <input type="text" class="form-control field" name="orgCode" placeholder="{{orgCode}} "  value=""/>
                </div>
            </div>
        </div>

        <div class="col-md-6 common_details">
            <div class="form-group">
                <label class="col-md-4 control-label">{{createTime}}：</label>
                <div class="col-md-8">
                    <input  class="form-control field" name="createTime"  value=""/>
                </div>
            </div>
        </div>

        <div class="col-md-6 common_details">
            <div class="form-group">
                <label class="col-md-4 control-label">{{createBy}}：</label>
                <div class="col-md-8">
                    <input  class="form-control field" name="createBy"  value=""/>
                </div>
            </div>
        </div>

        <div class="col-md-6 common_details">
            <div class="form-group">
                <label class="col-md-4 control-label">{{updateTime}}：</label>
                <div class="col-md-8">
                    <input  class="form-control field" name="updateTime"  value=""/>
                </div>
            </div>
        </div>

        <div class="col-md-6 common_details">
            <div class="form-group">
                <label class="col-md-4 control-label">{{updateBy}}：</label>
                <div class="col-md-8">
                    <input  class="form-control field" name="updateBy"  value=""/>
                </div>
            </div>
        </div>

		<div class="col-md-12">
              <div class="form-group">
                  <label class="col-md-2 control-label required">{{menuIds}}：</label>
                  <div class="col-md-10">
                      <!-- <input type="text" class="form-control field" name="menuIds" placeholder="菜单id " value=""/> -->

                      <div id='menuTree' class="form-control field tree" name="menuIds" 
                      style="height: 250px;">
                          
                      </div>
                  </div>
              </div>
          </div>

    </div>



    <!-- 搜索框，数据展示，分页 -->
    <div class="page-wrap">

        <div class="row" id='tablebox'  >
            <div class="col-lg-12">
                <div class="panel panel-lined table-responsive mb30 ng-scope">
                    <!-- 搜索框 -->
                    <div class="panel-body" style="padding-bottom: 0px" id='searchData'>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="col-md-4 control-label">{{orgName}}</label>
                                <div class="col-md-8">
                                    <input type="text" class="form-control field" name="orgName" placeholder="{{orgName}}" value=""/>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="col-md-4 control-label">{{status}}</label>
                                <div class="col-md-8">
                                    <select name="status" class="form-control field">
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <div class="col-md-12">
                                    <div style="width:185px;">
                                      <span id="searchBtn" class="btn btn-primary pull-left fa fa-search">{{search}}</span>
                                      <span id="resetBtn" class="btn btn-warning pull-right fa fa-refresh"> {{reset}}</span>
                                  </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    
                    <div style="padding: 0 20px;" class="panel-body">
                        <!-- 新增 -->
                        <span class="btn btn-sm btn-success pull-right globalData-add fa fa-plus hoverBtn" name='新增'
                        btnType='add'></span>

                    </div>
                    <div class="panel-body">
                        <table class="table table-bordered table-striped zCheckBox" id="bootstrap-table">
                            <thead class="thead">
                            <tr>
                                <!-- <th><span class="zCBox zCheckAll"></span></th> -->
                                <th>机构名称</th>
                                <th>机构ID</th>
                                <th>创建人</th>
                                <th>邮箱</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody id="globalDataTbody">
                            <tr>
                                <td colspan="20" style="text-align: center;">{{loading}}</td>
                            </tr>
                            </tbody>
                        </table>
                    <!-- #end data table -->
                    <!-- 分页 -->
                    <div class="page">
                        <div class="pager_container" id="Pagination">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</script>
<script>
//定义全局对象
var globalData={
  name:{
    zh_cn:'机构',en_us:'ORG',zh_cht:'机构'
  },

  detailStr:function(){
    return this['name'][lang.getLang()] + lang.getData('list');
  },

  editStr:function(){
    return lang.getData('edit') + this['name'][lang.getLang()] ;

  },

  addStr:function(){
    return lang.getData('add') + this['name'][lang.getLang()] ;
  },

  delStr:function(name){
    return lang.getData('delStr');
  },


  init:function(){
    //生成整体数据，主要为国际化语言服务
    $('#main').prepend(template('globalData_comOrg',$.dataLanguage()));
   //页面初始化默认请求表格数据
    this.getData(globalData.options);
    //调用所有事件
    this.event();
    this.getMenuTree();
    this.getOrg();
    $.zCompositeData(common_params['rbac']['orgStatus'],'#searchData [name="status"]',true);

    //填充验证
    $.zCommonReg(reg.email,'[name="email"]');
    $.zCommonReg(reg.phonenumber,'[name="phone"]');

    $.inputReg('#dataView [name="orderNum"]','keyup','number')

  },

  //定义全局请求参数对象
  data:{
  },
  
  treeFn:function(){
	    $(this).toggleClass('active');
	    $(this).closest('div').find('.errMsgSpan').remove();
	    var li=$(this).next('.treemenu').find('li');
	    if($(this).hasClass('active')){
	      var a=$(this).closest('.treemenu').prev('a.treeA').addClass('active')
	      a.closest('.treemenu').prev('a.treeA').addClass('active')
	      li.each(function(){
	          $(this).find('.treeA').addClass('active');
	      });
	    }else{
	      li.each(function(){
	          $ (this).find('.treeA').removeClass('active');
	      });
	    }
	  },

  options:{
    id: "orgId",
    parentId: "parentId",
    url: project.host() + "/v1/comOrgs", 
    modalName: "机构",
    columns: [{
        field: 'orgName',
        title: lang.getData('orgName'),
        align: 'left'
    },
    {
        field: 'orderNum',
        title: lang.getData('orgOrderNum'),
        align: "center"
    },
    {
        field: 'status',
        title: lang.getData('status'),
        align: "center",
        formatter: function(value, index) {
          // return item=='0'?'<span class="badge badge-primary">正常</span>':'<span class="badge badge-danger">停用</span>';
          var str='';
          common_params['rbac']['orgStatus'].forEach(function(n,i){
              if(n.value == value)str=n.name1[lang.getLang()];
          });
          return str
        }
    },
    {
        field: 'createTime',
        title: lang.getData('createTime'),
        align: "center"
    },
    {
        title: lang.getData('operation'),
        width:'180px',
        align: 'center',
        formatter: function(value, row, index) {
          var actions = [];
          actions.push('<span orgId='+row.orgId+' class="btn btn-sm btn-warning editBtn fa fa-edit hoverBtn" name="编辑" btnType="edit" onclick="globalData.updateView(this)"></span> ');
          actions.push('<span orgId='+row.orgId+' class="btn btn-sm btn-info detailBtn fa fa-tags hoverBtn" name="详情" btnType="list" onclick="globalData.updateView(this)"></span> ');
          actions.push('<span orgId='+row.orgId+' class="btn btn-sm btn-danger delBtn fa fa-trash-o hoverBtn" name="删除"" btnType="remove" onclick="globalData.updateView(this)"></span> ');
          return actions.join('');

        }
    }]
  },

  

  //请求表格数据的函数，参数data
  getData:function(options,data){

    data=data?data:{};
    options.url= project.host() + "/v1/comOrgs";
    var url=http_builder_url(options.url, data);
    options.url=url;
    $.treeTable.init(options);
    // setTimeout(function () {
    //   $.btnPermissions();
    // },1000);
    
  },
  
  getMenuTree:function(){
	    $.zAjax({
	      url: project.host()+'/v1/comMenus/menuTreeData' ,
	      // data:data,
	      isString:false,
	      success: function(data) {

	        var html=new treeMenu(data).init({
	            treeType:'menuTree',
	            pIdKey:'pId',
	            pIdInit:'0',
	        });
	        $('#menuTree').html(html);
	        $("#menuTree>ul").treemenu({delay:400}).openActive();
	           
	       }
	    });

	  },

  getOrg:function(data){
    $.zAjax({
      url: project.host()+'/v1/comOrgs/orgTreeData' ,
      // data:data,
      isString:false,
      success: function(data) {
        var html=new treeMenu(data).init({
            treeType:'orgTree',
            pIdKey:'pId',
            pIdInit:'0',
        });
        $('#treeBox').html(html);
        $("#treeBox>ul").treemenu({delay:400}).openActive();
       }
    });

    
    
  },

  //回显数据,同时可用于区分新增和（详情修改）的区别
  getglobalDataDetail:function(_id,ele,view){
	$('#menuTree [_id]').removeClass('active');
    $('.tree-opened').removeClass().addClass('tree-closed');
    $('#menuTree .treemenu').hide();
    $('#menuTree>.treemenu').show();
	//菜单树点击效果
	$('#menuTree').off().on('click','a.treeA',globalData.treeFn);
	
    $(ele).find('.field').val('');
    _id=$.trim(_id);
    //如果_id有效，则是详情或者修改
    if(_id){
      $.zAjax({
        url: project.host()+'/v1/comOrgs/'+_id ,
        isString:false,
        success: function(data) {
          $(ele).find('.field').each(function(){
            var key=$(this).attr('name');
            $(this).val(data[key]);
            if(key == 'status'){
                if(data[key] == '0') {
                    $(this).prop("checked",true);
                }else{
                    $(this).prop("checked",false);
                }
            }

          });
          if($('[name="parentId"]').attr('readonly')){
              $(ele).find('.field').val('');
              $('[name="parentId"]').val(data.orgName);
              $('[name="parentId"]').next('input[type="hidden"]').val(data.orgId);
          }else{
              $('[name="parentId"]').val(data.parentName?data.parentName:lang.getData('null'));
              $('[name="parentId"]').next('input[type="hidden"]').val(data.parentId);
          }
          
          /* $('[name="orgId"]').attr('disabled','disabled').val(data.orgName);
          $('[name="orgId"]').next('input[type="hidden"]').val(data.orgId); */
          var list=data.menuIds?data.menuIds.split(','):[];
          	debugger;
          	 
          list.forEach(function(n,i){
              $('.treeA[_id='+n+']').addClass('active');
          });
          /* if($(slef).hasClass('detailBtn')){
          	debugger;
              $('#zCheck').off('click').addClass('active');
          } 
           */
          view();

        }
      });
    }
    //否则是新增
    else{
      view();
      $('[name="parentId"]').removeAttr('readonly').val(lang.getData('mainOrg'));
      $('[name="parentId"]').next('input[type="hidden"]').val('0');
      
    }

  },

  //详情，新增，修改
  updateView:function(slef){
    var name=$(slef).attr('name'),title='',DelName;
    //获取当前ID，如果是新增，则没有ID
    var _id=$(slef).attr('orgId');


    if(name == '新增' && _id){
        title=globalData.addStr();
        $('[name="parentId"]').attr('readonly','readonly');
    }else if(name == '删除'){

        title=globalData.delStr();
        DelName='';

    }else if(name == '编辑'){
        title=globalData.editStr();
        $('[name="parentId"]').removeAttr('readonly');

    }else if(name == '详情'){
        title=globalData.detailStr();
        

    }else if(name == '分配菜单'){
        title=globalData.orgMenuStr();
        

    }else if(!_id){
        title=globalData.addStr();
       
    }

    //如果机构点击的是删除
    if(typeof DelName  == 'string'){
      layer.confirm(globalData.delStr(DelName),function(){
        $.zAjax({
          url: project.host()+'/v1/comOrgs/'+_id,
          type:'DELETE',
          isString:false,
          success: function(data) {
            layer.closeAll();
              layer.msg(lang.getData('delSuccess'),{icon:1});
              globalData.getData(globalData.options);      
          }
        });
      })
      return;
    }
    
    /**
   * 集合新增，修改，详情的方法
   * @param1    需展示的title
   * @param2    当前按钮本身
   * @param3    当前数据id
   * @param4    需要验证以及回显数据的表单
   * @param5    回显数据方法
   * @param7    新增，修改，详情的回调
   */
    $.zUpdateView(title,slef,_id,'#dataView',globalData.getglobalDataDetail,{
      //新增的回调,同时将传回通过校验的对象参数
      add:function(data){
        $.zAjax({
          url: project.host()+'/v1/comOrgs' , 
          isString:true,
          type:'post',
          data:data,
          success: function(data) {
            layer.closeAll();
            layer.msg(lang.getData('addSuccess'),{icon:1});
            globalData.getData(globalData.options);
            
          }
        });
      },
      //编辑的回调,同时将传回通过校验的对象参数
      edit:function(data){
        if(!$('[name="parentId"]').attr('readonly')){
          $.zAjax({
            url: project.host()+'/v1/comOrgs/'+_id , 
            isString:true,
            data:data,
            type:'PUT',
            success: function(data) {
              layer.closeAll();
              layer.msg(lang.getData('editSuccess'),{icon:1});
              globalData.getData(globalData.options);
            }
          });
        }else{
          $.zAjax({
            url: project.host()+'/v1/comOrgs' , 
            isString:true,
            type:'post',
            data:data,
            success: function(data) {
              layer.closeAll();
              layer.msg(lang.getData('addSuccess'),{icon:1});
              globalData.getData(globalData.options);
            }
          });
        }


      },
      //详情的回调
      detail:function(){
      }
    });
  },

  event:function(){

    //状态选择
    $('#dataView [name="status"]').click(function(){
        if($(this).prop("checked")){
            $(this).val('0');
        }else{
            $(this).val('1');
        }
    });


    //新增和修改选择机构树
    $('#treeBox').on('click','a.treeA',function(){
      $('#treeBox a.treeA').removeClass('active');
      $(this).addClass('active');
    })



    //弹出树的弹框
    $('[name="parentId"]').click(function(){
      if($(this).attr('readonly'))return;
      // var val=$('[name="parentId"]').next('input[type="hidden"]').val();
      var parentId=$('[name="parentId"]').next('input[type="hidden"]').val();
      if(parentId == '0' && $('[name="parentId"]').val()!= lang.getData('mainOrg')){
        layer.alert(lang.getData('notOneMenu'),{icon:2});
        return;
      }else{
        $('#treeBox a.treeA').removeClass('active');
        $('#treeBox a.treeA').each(function(i,n) {
          var _id=$(this).attr('_id');
          if( _id == parentId){
            var _slef=$(this);
            _slef.addClass('active');
            $('#treeBox .tree-opened').removeClass().addClass('tree-opened');
            $('#treeBox .treemenu').show();
            var _this=$(this);
            setTimeout(function(argument) {
              var top=_this.offset().top - 260;
              $('#treeBox').animate({'scrollTop':top},400,function(){
                layer.tips(lang.getData('parMenuIsHere'),_this,{ tips: [1, common_params['rbac'].color.error] })
              });
            },700);
            return;
          }
        });
      }
      var layerT=$.zOpen({
        title:lang.getData('changeOrg'),
        ele:'#treeBox',
        shade:.1,
        callback:function(){
          var _slef=$('#treeBox a.treeA.active');
          var _id=_slef.attr('_id');
          var _html=_slef.html();

          if(_id && _html){
            $('[name="parentId"]').val(_html);
            $('[name="parentId"]').next('input[type="hidden"]').val(_id);
            layer.close(layerT);
          }else{
            layer.msg(lang.getData('pleaseChangeOrg'));
            return false
          }

        }
      });
    });

    //搜索按钮事件
    $('#searchBtn').click(function(){
      var data=$.zSearchFn(globalData.data,'#searchData .field');
      globalData.getData(globalData.options,data);
    });

    //重置按钮事件
    $('#resetBtn').click(function(){
      var data=$.zResetFn(globalData.data,'#searchData .field');
      data=undefined;
      globalData.getData(globalData.options,data)
    });

    //新增按钮事件
    $('.globalData-add').click(function(){
      globalData.updateView(this);
    });


  }
}



$(document).ready(function() {
  //初始化
  globalData.init();

});




</script>